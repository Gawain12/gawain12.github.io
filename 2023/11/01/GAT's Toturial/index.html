

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Gawain">
  <meta name="keywords" content="Share">
  
    <meta name="description" content="GATæ•™ç¨‹æœ¬æ–‡æ¥è‡ªå¯¹ä½œè€…gordicaleksaçš„notebookä»£ç pytorch-GATçš„ç¿»è¯‘ã€‚æ„Ÿè°¢ä½œè€…æœ¬æ–‡çš„æƒ³æ³•æ˜¯è®©éç ”ç©¶äººå‘˜ä¹Ÿèƒ½æ›´è½»æ¾åœ°ç†è§£å›¾æ³¨æ„åŠ›ç½‘ç»œï¼ˆä»¥åŠé€šç”¨çš„GNNï¼‰ï¼ åœ¨æœ¬æ–‡ä¸­ï¼Œæ‚¨å°†è·å¾—ä»¥ä¸‹é—®é¢˜çš„ç­”æ¡ˆï¼š âœ… GAT åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿâœ… å¦‚ä½•åŠ è½½å’Œå¯è§†åŒ–Coraå¼•æ–‡ç½‘ç»œï¼Ÿâœ… æˆ‘ä»¬å¦‚ä½•è®­ç»ƒGATï¼ˆCoraåˆ†ç±»ç¤ºä¾‹ï¼‰ï¼Ÿâœ… å¦‚ä½•å¯è§†åŒ–ä¸åŒGATçš„å±æ€§ï¼Ÿ å®Œæˆæœ¬è¯¾ç¨‹åï¼Œæ‚¨å°†å¯¹å›¾ç¥ç»ç½‘ç»œæœ‰æ›´å¥½çš„ç†">
<meta property="og:type" content="article">
<meta property="og:title" content="GATæ•™ç¨‹">
<meta property="og:url" content="https://gawain12.github.io/2023/11/01/GAT's%20Toturial/index.html">
<meta property="og:site_name" content="Gawain&#39;s notes">
<meta property="og:description" content="GATæ•™ç¨‹æœ¬æ–‡æ¥è‡ªå¯¹ä½œè€…gordicaleksaçš„notebookä»£ç pytorch-GATçš„ç¿»è¯‘ã€‚æ„Ÿè°¢ä½œè€…æœ¬æ–‡çš„æƒ³æ³•æ˜¯è®©éç ”ç©¶äººå‘˜ä¹Ÿèƒ½æ›´è½»æ¾åœ°ç†è§£å›¾æ³¨æ„åŠ›ç½‘ç»œï¼ˆä»¥åŠé€šç”¨çš„GNNï¼‰ï¼ åœ¨æœ¬æ–‡ä¸­ï¼Œæ‚¨å°†è·å¾—ä»¥ä¸‹é—®é¢˜çš„ç­”æ¡ˆï¼š âœ… GAT åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿâœ… å¦‚ä½•åŠ è½½å’Œå¯è§†åŒ–Coraå¼•æ–‡ç½‘ç»œï¼Ÿâœ… æˆ‘ä»¬å¦‚ä½•è®­ç»ƒGATï¼ˆCoraåˆ†ç±»ç¤ºä¾‹ï¼‰ï¼Ÿâœ… å¦‚ä½•å¯è§†åŒ–ä¸åŒGATçš„å±æ€§ï¼Ÿ å®Œæˆæœ¬è¯¾ç¨‹åï¼Œæ‚¨å°†å¯¹å›¾ç¥ç»ç½‘ç»œæœ‰æ›´å¥½çš„ç†">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i-blog.csdnimg.cn/blog_migrate/45d6723d19b7b712df7a148478dd9256.png">
<meta property="og:image" content="https://ptpimg.me/92t60u.png">
<meta property="og:image" content="https://ptpimg.me/s94oh0.png">
<meta property="og:image" content="https://ptpimg.me/yt72e1.png">
<meta property="og:image" content="https://ptpimg.me/mv5zat.png">
<meta property="og:image" content="https://ptpimg.me/855sl2.png">
<meta property="og:image" content="https://ptpimg.me/kk5k1q.png">
<meta property="og:image" content="https://ptpimg.me/02bw9r.png">
<meta property="og:image" content="https://ptpimg.me/8c77s3.png">
<meta property="og:image" content="https://ptpimg.me/6pt7d4.png">
<meta property="og:image" content="https://ptpimg.me/6q14cf.png">
<meta property="og:image" content="https://ptpimg.me/vdku0v.png">
<meta property="article:published_time" content="2023-10-31T17:29:04.000Z">
<meta property="article:modified_time" content="2024-07-30T11:58:29.243Z">
<meta property="article:author" content="Gawain">
<meta property="article:tag" content="Share">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i-blog.csdnimg.cn/blog_migrate/45d6723d19b7b712df7a148478dd9256.png">
  
  
  
  <title>GATæ•™ç¨‹ - Gawain&#39;s notes</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"gawain12.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"FeJdeqy6cDDAySGfsLP8g1bl-MdYXbMMI","app_key":"Hj6SxzGjyvHq8tHLJTqtcyHZ","server_url":"https://fejdeqy6.api.lncldglobal.com","path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Gawain&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-category-fill"></i>
                <span>ä¹¦å½±éŸ³è®°å½•</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/books/" target="_self">
                    <i class="icofont-abc"></i>
                    <span>ğŸ“–æ–‡å­¦</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/movies/" target="_self">
                    <i class="icofont-love"></i>
                    <span>ğŸ¬ç”µå½±</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/songs/" target="_self">
                    <i class="icofont-notebook"></i>
                    <span>ğŸµéŸ³ä¹</span>
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/remark/" target="_self">
                
                <span>ç•™è¨€æ¿</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="GATæ•™ç¨‹"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-11-01 01:29" pubdate>
          2023å¹´11æœˆ1æ—¥ å‡Œæ™¨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          112 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">GATæ•™ç¨‹</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äº 2024å¹´7æœˆ30æ—¥ æ™šä¸Š
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="GATæ•™ç¨‹"><a href="#GATæ•™ç¨‹" class="headerlink" title="GATæ•™ç¨‹"></a>GATæ•™ç¨‹</h1><h3 id="æœ¬æ–‡æ¥è‡ªå¯¹ä½œè€…gordicaleksaçš„notebookä»£ç pytorch-GATçš„ç¿»è¯‘ã€‚æ„Ÿè°¢ä½œè€…"><a href="#æœ¬æ–‡æ¥è‡ªå¯¹ä½œè€…gordicaleksaçš„notebookä»£ç pytorch-GATçš„ç¿»è¯‘ã€‚æ„Ÿè°¢ä½œè€…" class="headerlink" title="æœ¬æ–‡æ¥è‡ªå¯¹ä½œè€…gordicaleksaçš„notebookä»£ç pytorch-GATçš„ç¿»è¯‘ã€‚æ„Ÿè°¢ä½œè€…"></a><strong>æœ¬æ–‡æ¥è‡ªå¯¹ä½œè€…gordicaleksaçš„notebookä»£ç <a target="_blank" rel="noopener" href="https://github.com/gordicaleksa/pytorch-GAT">pytorch-GAT</a>çš„ç¿»è¯‘ã€‚æ„Ÿè°¢ä½œè€…</strong></h3><p>æœ¬æ–‡çš„æƒ³æ³•æ˜¯è®©éç ”ç©¶äººå‘˜ä¹Ÿèƒ½æ›´è½»æ¾åœ°ç†è§£å›¾æ³¨æ„åŠ›ç½‘ç»œï¼ˆä»¥åŠé€šç”¨çš„GNNï¼‰ï¼</p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæ‚¨å°†è·å¾—ä»¥ä¸‹é—®é¢˜çš„ç­”æ¡ˆï¼š</p>
<p>âœ… GAT åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ<br/><br>âœ… å¦‚ä½•åŠ è½½å’Œå¯è§†åŒ–Coraå¼•æ–‡ç½‘ç»œï¼Ÿ<br/><br>âœ… æˆ‘ä»¬å¦‚ä½•è®­ç»ƒGATï¼ˆCoraåˆ†ç±»ç¤ºä¾‹ï¼‰ï¼Ÿ<br/><br>âœ… å¦‚ä½•å¯è§†åŒ–ä¸åŒGATçš„å±æ€§ï¼Ÿ<br/></p>
<p>å®Œæˆæœ¬è¯¾ç¨‹åï¼Œæ‚¨å°†å¯¹å›¾ç¥ç»ç½‘ç»œæœ‰æ›´å¥½çš„ç†è§£ï¼</p>
<p><em>æ³¨æ„ï¼šåœ¨æœ¬ç¬”è®°æœ¬ä¸­ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨ Coraï¼ˆä¼ å¯¼æ³•ç¤ºä¾‹ï¼‰ï¼Œå¦‚æœéœ€è¦å¯ä»¥æŸ¥çœ‹å…¶ä»–ç¬”è®°æœ¬ä¸­çš„PPI - è›‹ç™½è´¨ç›¸äº’ä½œç”¨æ•°æ®é›†ï¼ˆå½’çº³æ³•ï¼‰ã€‚</em></p>
<p>å¾ˆå¥½ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼</p>
<hr>
<h2 id="å›¾æ³¨æ„åŠ›ç½‘ç»œåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#å›¾æ³¨æ„åŠ›ç½‘ç»œåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="å›¾æ³¨æ„åŠ›ç½‘ç»œåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ"></a>å›¾æ³¨æ„åŠ›ç½‘ç»œåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å›¾æ³¨æ„åŠ›ç½‘ç»œï¼ˆGraph Attention Networkï¼‰ï¼Œç®€ç§° GATï¼Œæ˜¯ä¸€ç§å›¾ç¥ç»ç½‘ç»œï¼ˆGNNï¼‰ï¼Œæ—©åœ¨ 2017 å¹´å°±åœ¨ä¸€ç¯‡åä¸º<a target="_blank" rel="noopener" href="https://arxiv.org/abs/1710.10903">ã€ŠGraph Attention Networksã€‹</a>VeliÄkoviÄ‡ et al.çš„è®ºæ–‡ä¸­å‘è¡¨ã€‚</p>
<p>äº‹å®è¯æ˜ï¼Œå°†æ³¨æ„åŠ›çš„æƒ³æ³•ä¸ç°æœ‰çš„å›¾å·ç§¯ç½‘ç»œï¼ˆGCNï¼‰ç›¸ç»“åˆæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¸¾æªï¼ŒGATæ˜¯GNNæ–‡çŒ®ä¸­è¢«å¼•ç”¨æ¬¡æ•°ç¬¬äºŒå¤šçš„è®ºæ–‡ï¼ˆæˆªè‡³æ’°å†™æœ¬æ–‡æ—¶ï¼‰ã€‚</p>
<p>å› ä¸º<code>GCN + attention = GAT</code>ä¸ºäº†ç†è§£GATï¼Œä½ åŸºæœ¬ä¸Šéœ€è¦ç†è§£GCNã€‚</p>
<p>æ•´ä¸ªæƒ³æ³•æ¥è‡ª CNNã€‚å·ç§¯ç¥ç»ç½‘ç»œå‘å±•éå¸¸å¥½ï¼Œè§£å†³äº†å„ç§è®¡ç®—æœºè§†è§‰ä»»åŠ¡ï¼Œå¹¶åœ¨æ·±åº¦å­¦ä¹ é¢†åŸŸå¼•èµ·äº†å·¨å¤§çš„è½°åŠ¨ï¼Œå› æ­¤ä¸€äº›äººå†³å®šå°†è¿™ä¸ªæƒ³æ³•è½¬ç§»åˆ°å›¾ä¸Šã€‚</p>
<p>åŸºæœ¬é—®é¢˜æ˜¯ï¼Œè™½ç„¶å›¾åƒä½äºè§„åˆ™ç½‘æ ¼ä¸Šï¼ˆæ‚¨ä¹Ÿå¯ä»¥å°†å…¶è§†ä¸ºå›¾å½¢ï¼‰ï¼Œä½†å› æ­¤å…·æœ‰ç²¾ç¡®çš„é¡ºåºæ¦‚å¿µï¼ˆä¾‹å¦‚æˆ‘çš„å·¦ä¸Šè§’é‚»å±…ï¼ˆé€šå¸¸ç§°ä¸ºCVä¸–ç•Œé‡Œçš„åƒç´ ï¼‰))ï¼Œå›¾ä¸å…·å¤‡è¿™ç§è‰¯å¥½çš„ç‰¹æ€§ï¼Œå¹¶ä¸”é‚»å±…çš„æ•°é‡ä»¥åŠé‚»å±…çš„é¡ºåºéƒ½å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•ä¸ºå›¾å®šä¹‰å†…æ ¸å‘¢ï¼Ÿå†…æ ¸å¤§å°ä¸èƒ½æ˜¯è¿™æ ·3x3ï¼Œå› ä¸ºæœ‰æ—¶ä¸€ä¸ªèŠ‚ç‚¹æœ‰2ä¸ªé‚»å±…ï¼Œæœ‰æ—¶æ˜¯ 233240ï¼ˆ<em>æŠ“ç‹‚</em>ï¼‰ã€‚</p>
<p>å‡ºç°äº† 2 ä¸ªä¸»è¦æƒ³æ³•ï¼š</p>
<ul>
<li>è°±æ–¹æ³•ï¼ˆå®ƒä»¬éƒ½ä»¥æŸç§æ–¹å¼åˆ©ç”¨å›¾æ‹‰æ™®æ‹‰æ–¯ç‰¹å¾åŸºï¼ˆæˆ‘åœ¨è¿™é‡Œå®Œå…¨å¿½ç•¥å®ƒä»¬ï¼‰ï¼‰</li>
<li>ç©ºé—´æ–¹æ³•</li>
</ul>
<p>å°½ç®¡ç©ºé—´æ–¹æ³•å¯èƒ½éšçº¦å—åˆ°è°±æ–¹æ³•çš„å¯å‘ï¼Œä½†ç›´æ¥ä»ç©ºé—´è§’åº¦æ€è€ƒå®ƒä»¬è¦å¥½å¾—å¤šã€‚å¥½çš„ï¼Œå°±è¿™æ ·å§ã€‚</p>
<hr>
<p><strong>ç©ºé—´ï¼ˆæ¶ˆæ¯ä¼ é€’ï¼‰æ–¹æ³•çš„é«˜çº§è§£é‡Šï¼š</strong></p>
<p>æ‰€ä»¥ä½ å¯ä»¥ä½¿ç”¨æ¥è‡ªé‚»å±…çš„ç‰¹å¾å‘é‡ã€‚æ‚¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>ä½ ä»¥æŸç§æ–¹å¼å˜æ¢å®ƒä»¬ï¼ˆä¹Ÿè®¸æ˜¯çº¿æ€§æŠ•å½±ï¼‰</li>
<li>ä½ ä»¥æŸç§æ–¹å¼èšåˆå®ƒä»¬ï¼ˆä¹Ÿè®¸ç”¨æ³¨æ„åŠ›ç³»æ•°æ¥è¡¡é‡å®ƒä»¬ï¼Œç§ï¼Œæˆ‘ä»¬å¾—åˆ°äº† GATï¼ˆä½ çœ‹æˆ‘åœ¨é‚£é‡Œåšäº†ä»€ä¹ˆï¼‰ï¼‰</li>
<li>æ‚¨å¯ä»¥é€šè¿‡å°†å½“å‰èŠ‚ç‚¹ï¼ˆå˜æ¢åçš„ï¼‰ç‰¹å¾å‘é‡ä¸èšåˆé‚»å±…è¡¨ç¤ºç›¸ç»“åˆæ¥æ›´æ–°å½“å‰èŠ‚ç‚¹çš„ç‰¹å¾å‘é‡ï¼ˆä»¥æŸç§æ–¹å¼ï¼‰ã€‚<br>å·®ä¸å¤šå°±æ˜¯è¿™æ ·ï¼Œä½ å¯ä»¥å°†è®¸å¤šä¸åŒçš„ GNN æ”¾å…¥è¿™ä¸ªæ¡†æ¶ä¸­ã€‚</li>
</ol>
<p>GAT ç¤ºæ„å›¾å¦‚ä¸‹ï¼ˆä¸åŒé¢œè‰²çš„è¾¹ä»£è¡¨ä¸åŒçš„æ³¨æ„åŠ›å¤´ï¼‰ï¼š<br><img src="https://i-blog.csdnimg.cn/blog_migrate/45d6723d19b7b712df7a148478dd9256.png" srcset="/img/loading.gif" lazyload alt="transformer architecture" align="center" style="width: 500px;"/> <br/></p>
<p><strong>æœ‰è¶£çš„äº‹å®:</strong> <em>transformers</em> å¯ä»¥è¢«è®¤ä¸ºæ˜¯GATçš„ä¸€ä¸ªç‰¹ä¾‹â€”å½“è¾“å…¥å›¾æ˜¯<strong>å…¨è¿æ¥</strong>æ—¶ã€‚æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://thegradient.pub/transformers-are-graph-neural-networks/">æ­¤åšå®¢</a>äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</p>
<hr>
<p>è¿™å°±æ˜¯æ‚¨ç°åœ¨éœ€è¦äº†è§£çš„ä¸€åˆ‡ï¼</p>
<p>å¦‚æœæ‚¨éœ€è¦è¿›ä¸€æ­¥å¸®åŠ©ç†è§£æ‰€æœ‰ç»†èŠ‚ï¼Œæˆ‘ä»¬åˆ›å»ºäº† <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=uFLeKkXWq2c">in-depth overview of the GAT paper:</a>è¿™ç¯‡GAT è®ºæ–‡çš„æ·±å…¥æ¦‚è¿°ï¼š</p>
<p>é‡è¦æç¤ºï¼šæ­¤ç¬”è®°æœ¬ä¸­çš„ä»£ç æ˜¯è¿™ä¸ªrepoä¸­å¯ä»¥ä½¿ç”¨çš„ä»£ç çš„å­é›†ã€‚æˆ‘å°†åœ¨è¿™é‡Œé‡ç‚¹å…³æ³¨å•ä¸ªGATå®ç°ï¼ˆæ¦‚å¿µä¸Šæœ€éš¾ç†è§£çš„å®ç°ï¼Œä½†åŒæ—¶ä¹Ÿæ˜¯æœ€æœ‰æ•ˆçš„å®ç°ï¼‰ã€‚è¯·æ³¨æ„ï¼Œæˆ‘å®é™…ä¸Šåœ¨repoä¸­æœ‰3ä¸ªGATå®ç°ã€‚</p>
<p>æŠ›å¼€è¿™äº›ï¼Œè®©æˆ‘ä»¬å¼€å§‹æ·±å…¥ç ”ç©¶å§ï¼è®©æˆ‘ä»¬ä»ä¸æ•°æ®åŠ è½½å’Œå¯è§†åŒ–ç›¸å…³çš„å¯¼å…¥å¼€å§‹ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># I always like to structure my imports into Python&#x27;s native libs,</span><br><span class="hljs-comment"># stuff I installed via conda/pip and local file imports (but we don&#x27;t have those here)</span><br><br><span class="hljs-keyword">import</span> pickle<br><br><span class="hljs-comment"># å¯è§†åŒ–ç›¸å…³å¯¼å…¥</span><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><span class="hljs-keyword">import</span> networkx <span class="hljs-keyword">as</span> nx<br><span class="hljs-keyword">import</span> igraph <span class="hljs-keyword">as</span> ig<br>plt.rcParams[<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>] = [<span class="hljs-string">&#x27;SimHei&#x27;</span>]<br><span class="hljs-comment"># ä¸»è¦çš„è®¡ç®—ä¾èµ–</span><br><span class="hljs-keyword">import</span> scipy.sparse <span class="hljs-keyword">as</span> sp<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><br><span class="hljs-comment"># æ·±åº¦å­¦ä¹ ç›¸å…³</span><br><span class="hljs-keyword">import</span> torch<br></code></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> enum<br><br><span class="hljs-comment"># æ”¯æŒçš„æ•°æ®é›† - ä»…åœ¨æ­¤ç¬”è®°æœ¬ä¸­ä½¿ç”¨ Cora</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatasetType</span>(enum.Enum):<br>    CORA = <span class="hljs-number">0</span><br><br>    <br><span class="hljs-comment"># Networkx å¹¶ä¸æ˜¯ä¸“ä¸ºç»˜å›¾è€Œåˆ¶ä½œçš„ï¼Œä½†æˆ‘è¿›è¡Œäº†ä¸€äº›å®éªŒ</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphVisualizationTool</span>(enum.Enum):<br>    NETWORKX = <span class="hljs-number">0</span>,<br>    IGRAPH = <span class="hljs-number">1</span><br><br><br><span class="hljs-comment"># æˆ‘ä»¬å°†ä»æ­¤ç›®å½•ä¸­å¯¼å‡ºå’Œè¯»å–æ•°æ®</span><br>DATA_DIR_PATH = os.path.join(os.getcwd(), <span class="hljs-string">&#x27;data&#x27;</span>)<br>CORA_PATH = os.path.join(DATA_DIR_PATH, <span class="hljs-string">&#x27;cora&#x27;</span>)  <span class="hljs-comment"># è¿™æ˜¯å·²ç»æ£€å…¥çš„ï¼Œæ— éœ€åˆ›å»ºç›®å½•</span><br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Cora ç‰¹å®šå¸¸é‡</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-comment"># Thomas Kipf ç­‰äººåœ¨ GCN è®ºæ–‡ä¸­é¦–æ¬¡ä½¿ç”¨äº†æ­¤æ‹†åˆ†ï¼Œåæ¥ Petar VeliÄkoviÄ‡ ç­‰äººåœ¨ GAT è®ºæ–‡ä¸­ä¹Ÿä½¿ç”¨äº†å®ƒ</span><br>CORA_TRAIN_RANGE = [<span class="hljs-number">0</span>, <span class="hljs-number">140</span>]  <span class="hljs-comment"># æˆ‘ä»¬å°†å‰ 140 ä¸ªèŠ‚ç‚¹ç”¨ä½œè®­ç»ƒèŠ‚ç‚¹</span><br>CORA_VAL_RANGE = [<span class="hljs-number">140</span>, <span class="hljs-number">140</span>+<span class="hljs-number">500</span>]<br>CORA_TEST_RANGE = [<span class="hljs-number">1708</span>, <span class="hljs-number">1708</span>+<span class="hljs-number">1000</span>]<br>CORA_NUM_INPUT_FEATURES = <span class="hljs-number">1433</span><br>CORA_NUM_CLASSES = <span class="hljs-number">7</span><br><br><span class="hljs-comment"># æ— è®ºä½•æ—¶æˆ‘ä»¬éœ€è¦å¯è§†åŒ–æ¥è‡ªä¸åŒç±»åˆ«çš„ç‚¹æ—¶ï¼ˆt-SNEã€CORA å¯è§†åŒ–ï¼‰</span><br>cora_label_to_color_map = &#123;<span class="hljs-number">0</span>: <span class="hljs-string">&quot;red&quot;</span>, <span class="hljs-number">1</span>: <span class="hljs-string">&quot;blue&quot;</span>, <span class="hljs-number">2</span>: <span class="hljs-string">&quot;green&quot;</span>, <span class="hljs-number">3</span>: <span class="hljs-string">&quot;orange&quot;</span>, <span class="hljs-number">4</span>: <span class="hljs-string">&quot;yellow&quot;</span>, <span class="hljs-number">5</span>: <span class="hljs-string">&quot;pink&quot;</span>, <span class="hljs-number">6</span>: <span class="hljs-string">&quot;gray&quot;</span>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è¿™æ ·æˆ‘ä»¬å°±è§£é”äº†1çº§ï¼ˆæ•°æ®ğŸ“œï¼‰ã€‚æˆ‘ä»¬ç»§ç»­ï¼</p>
<h1 id="ç¬¬-1-éƒ¨åˆ†ï¼šäº†è§£æ‚¨çš„æ•°æ®ï¼ˆä¸æ•°æ®åˆè€Œä¸ºä¸€ğŸ“œâ¤ï¸ï¼‰"><a href="#ç¬¬-1-éƒ¨åˆ†ï¼šäº†è§£æ‚¨çš„æ•°æ®ï¼ˆä¸æ•°æ®åˆè€Œä¸ºä¸€ğŸ“œâ¤ï¸ï¼‰" class="headerlink" title="ç¬¬ 1 éƒ¨åˆ†ï¼šäº†è§£æ‚¨çš„æ•°æ®ï¼ˆä¸æ•°æ®åˆè€Œä¸ºä¸€ğŸ“œâ¤ï¸ï¼‰"></a>ç¬¬ 1 éƒ¨åˆ†ï¼šäº†è§£æ‚¨çš„æ•°æ®ï¼ˆä¸æ•°æ®åˆè€Œä¸ºä¸€ğŸ“œâ¤ï¸ï¼‰</h1><p>æˆ‘å°†ä½¿ç”¨ Cora å¼•æ–‡ç½‘ç»œä½œä¸ºæœ¬ç¬”è®°æœ¬ä¸­çš„è¿è¡Œç¤ºä¾‹ã€‚</p>
<p>è¯´åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šæƒ³ï¼Œä¼ å¯¼å­¦ä¹ å’Œå½’çº³å­¦ä¹ æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå¦‚æœæ‚¨ä¸ç†Ÿæ‚‰ GNNï¼Œè¿™å¯èƒ½çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„æ¦‚å¿µã€‚ä½†å®é™…ä¸Šå¾ˆç®€å•ã€‚</p>
<p><strong>ä¼ å¯¼æ³•</strong> - ä½ æœ‰ä¸€ä¸ªå›¾ï¼ˆå¦‚ Coraï¼‰ï¼Œä½ å°†ä¸€äº›èŠ‚ç‚¹ï¼ˆè€Œä¸æ˜¯å›¾ï¼‰åˆ†æˆè®­ç»ƒ&#x2F;éªŒè¯&#x2F;æµ‹è¯•è®­ç»ƒé›†ã€‚åœ¨è®­ç»ƒæ—¶ï¼Œæ‚¨å°†ä»…ä½¿ç”¨è®­ç»ƒèŠ‚ç‚¹ä¸­çš„æ ‡ç­¾ã€‚ä½†ã€‚åœ¨å‰å‘ä¼ æ’­æœŸé—´ï¼Œæ ¹æ®ç©ºé—´ GNN å·¥ä½œæ–¹å¼çš„æœ¬è´¨ï¼Œæ‚¨å°†èšåˆæ¥è‡ªé‚»å±…çš„ç‰¹å¾å‘é‡ï¼Œå…¶ä¸­ä¸€äº›å¯èƒ½å±äºéªŒè¯ç”šè‡³æµ‹è¯•é›†ï¼è¦ç‚¹æ˜¯ - æ‚¨æ²¡æœ‰ä½¿ç”¨å®ƒä»¬çš„æ ‡ç­¾ä¿¡æ¯ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ç»“æ„ä¿¡æ¯åŠå…¶ç‰¹å¾ã€‚</p>
<p><strong>å½’çº³æ³•</strong> - å¦‚æœæ‚¨æœ‰è®¡ç®—æœºè§†è§‰æˆ– NLPåŸºç¡€ï¼Œæ‚¨å¯èƒ½ä¼šæ›´ç†Ÿæ‚‰è¿™ä¸€æ¦‚å¿µã€‚æ‚¨æœ‰ä¸€ç»„è®­ç»ƒå›¾ã€ä¸€ç»„å•ç‹¬çš„éªŒè¯å›¾ï¼Œå½“ç„¶è¿˜æœ‰ä¸€ç»„å•ç‹¬çš„æµ‹è¯•å›¾ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾åˆ†ç±»ä»»åŠ¡ä¸­ï¼Œè®­ç»ƒæ•°æ®å¯ä»¥åŒ…å«å¸¦æ ‡ç­¾çš„å›¾ï¼Œæµ‹è¯•æ•°æ®å¯ä»¥åŒ…å«ä¸å¸¦æ ‡ç­¾çš„å›¾ã€‚æ¨¡å‹åªèƒ½åˆ©ç”¨è®­ç»ƒæ•°æ®ä¸­çš„å›¾æ¥å­¦ä¹ å›¾åˆ†ç±»æ¨¡å‹ã€‚</p>
<p>è§£é‡Šè¿™äº›å®Œåï¼Œè®©æˆ‘ä»¬è¿›å…¥ä»£ç å¹¶åŠ è½½å’Œå¯è§†åŒ– Coraã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®šä¹‰è¿™äº›ç®€å•çš„åŠŸèƒ½ç”¨äºåŠ è½½/ä¿å­˜pickleæ–‡ä»¶ - ä¸ºäº†Coraæˆ‘ä»¬éœ€è¦å®ƒä»¬</span><br><br><span class="hljs-comment"># æ‰€æœ‰Coraæ•°æ®éƒ½å­˜å‚¨ä¸ºpickleæ–‡ä»¶</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pickle_read</span>(<span class="hljs-params">path</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>        data = pickle.load(file)<br><br>    <span class="hljs-keyword">return</span> data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pickle_save</span>(<span class="hljs-params">path, data</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>        pickle.dump(data, file, protocol=pickle.HIGHEST_PROTOCOL)<br></code></pre></td></tr></table></figure>

<p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åŠ è½½ Coraï¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># æˆ‘ä»¬ç¨åä¼šä¼ å…¥è®­ç»ƒé…ç½®å­—å…¸</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_graph_data</span>(<span class="hljs-params">training_config, device</span>):<br>    dataset_name = training_config[<span class="hljs-string">&#x27;dataset_name&#x27;</span>].lower()<br>    should_visualize = training_config[<span class="hljs-string">&#x27;should_visualize&#x27;</span>]<br><br>    <span class="hljs-keyword">if</span> dataset_name == DatasetType.CORA.name.lower():<br><br>        <span class="hljs-comment"># å½¢çŠ¶ = (N, FIN)ï¼Œå…¶ä¸­ N æ˜¯èŠ‚ç‚¹æ•°ï¼ŒFIN æ˜¯è¾“å…¥ç‰¹å¾æ•°</span><br>        node_features_csr = pickle_read(os.path.join(CORA_PATH, <span class="hljs-string">&#x27;node_features.csr&#x27;</span>))<br>        <span class="hljs-comment"># å½¢çŠ¶ = (N, 1)</span><br>        node_labels_npy = pickle_read(os.path.join(CORA_PATH, <span class="hljs-string">&#x27;node_labels.npy&#x27;</span>))<br>        <span class="hljs-comment"># å½¢çŠ¶ = (N, ç›¸é‚»èŠ‚ç‚¹æ•°) &lt;- è¿™æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œä¸æ˜¯çŸ©é˜µï¼</span><br>        adjacency_list_dict = pickle_read(os.path.join(CORA_PATH, <span class="hljs-string">&#x27;adjacency_list.dict&#x27;</span>))<br><br>        <span class="hljs-comment"># æ ‡å‡†åŒ–ç‰¹å¾ï¼ˆæœ‰åŠ©äºè®­ç»ƒï¼‰</span><br>        node_features_csr = normalize_features_sparse(node_features_csr)<br>        num_of_nodes = <span class="hljs-built_in">len</span>(node_labels_npy)<br><br>        <span class="hljs-comment"># å½¢çŠ¶ = (2, E)ï¼Œå…¶ä¸­ E æ˜¯è¾¹æ•°ï¼Œ2 æ˜¯æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹ã€‚åŸºæœ¬ä¸Šè¾¹ç¼˜ç´¢å¼•</span><br>        <span class="hljs-comment"># åŒ…å«æ ¼å¼ä¸º S-&gt;T çš„å…ƒç»„ï¼Œä¾‹å¦‚ 0-&gt;3 è¡¨ç¤ºå…·æœ‰ ID 0 çš„èŠ‚ç‚¹æŒ‡å‘å…·æœ‰ ID 3 çš„èŠ‚ç‚¹ã€‚</span><br>        topology = build_edge_index(adjacency_list_dict, num_of_nodes, add_self_edges=<span class="hljs-literal">True</span>)<br><br>        <span class="hljs-comment"># æ³¨æ„ï¼štopology åªæ˜¯å‘½åå›¾ç»“æ„æ•°æ®çš„èŠ±å“¨æ–¹å¼</span><br>        <span class="hljs-comment"># ï¼ˆé™¤è¾¹ç¼˜ç´¢å¼•ä¹‹å¤–ï¼Œå®ƒå¯ä»¥æ˜¯é‚»æ¥çŸ©é˜µçš„å½¢å¼ï¼‰</span><br><br>        <span class="hljs-keyword">if</span> should_visualize:  <span class="hljs-comment"># ç½‘ç»œåˆ†æå’Œå›¾ç»˜åˆ¶</span><br>            plot_in_out_degree_distributions(topology, num_of_nodes, dataset_name)  <span class="hljs-comment"># æˆ‘ä»¬å°†åœ¨ç¬¬äºŒéƒ¨åˆ†å®šä¹‰è¿™äº›</span><br>            visualize_graph(topology, node_labels_npy, dataset_name)<br><br>        <span class="hljs-comment"># è½¬æ¢ä¸ºç¨ å¯† PyTorch å¼ é‡</span><br><br>        <span class="hljs-comment"># éœ€è¦æ˜¯ long int ç±»å‹ï¼Œå› ä¸ºä»¥ååƒ PyTorch çš„ index_select è¿™æ ·çš„å‡½æ•°æœŸæœ›å®ƒ</span><br>        topology = torch.tensor(topology, dtype=torch.long, device=device)<br>        node_labels = torch.tensor(node_labels_npy, dtype=torch.long, device=device)  <span class="hljs-comment"># äº¤å‰ç†µæœŸæœ›ä¸€ä¸ª long int</span><br>        node_features = torch.tensor(node_features_csr.todense(), device=device)<br><br>        <span class="hljs-comment"># å¸®åŠ©æˆ‘ä»¬æå–å±äºè®­ç»ƒ/éªŒè¯å’Œæµ‹è¯•æ‹†åˆ†çš„èŠ‚ç‚¹çš„ç´¢å¼•</span><br>        train_indices = torch.arange(CORA_TRAIN_RANGE[<span class="hljs-number">0</span>], CORA_TRAIN_RANGE[<span class="hljs-number">1</span>], dtype=torch.long, device=device)<br>        val_indices = torch.arange(CORA_VAL_RANGE[<span class="hljs-number">0</span>], CORA_VAL_RANGE[<span class="hljs-number">1</span>], dtype=torch.long, device=device)<br>        test_indices = torch.arange(CORA_TEST_RANGE[<span class="hljs-number">0</span>], CORA_TEST_RANGE[<span class="hljs-number">1</span>], dtype=torch.long, device=device)<br><br>        <span class="hljs-keyword">return</span> node_features, node_labels, topology, train_indices, val_indices, test_indices<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;dataset_name&#125;</span> not yet supported.&#x27;</span>)<br><br></code></pre></td></tr></table></figure>

<p>å¾ˆå¥½ï¼Œæˆ‘è¿˜ä½¿ç”¨äº†å¦å¤– 2 ä¸ªå°šæœªå®šä¹‰çš„å‡½æ•°ã€‚é¦–å…ˆè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨ Cora ä¸Šè¿›è¡Œç‰¹å¾æ ‡å‡†åŒ–ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_features_sparse</span>(<span class="hljs-params">node_features_sparse</span>):<br>    <span class="hljs-keyword">assert</span> sp.issparse(node_features_sparse), <span class="hljs-string">f&#x27;Expected a sparse matrix, got <span class="hljs-subst">&#123;node_features_sparse&#125;</span>.&#x27;</span><br><br>    <span class="hljs-comment"># è€Œä¸æ˜¯åƒ normalize_features_dense() ä¸­é‚£æ ·è¿›è¡Œé™¤æ³•ï¼Œæˆ‘ä»¬å¯¹ç‰¹å¾çš„é€†å’Œè¿›è¡Œä¹˜æ³•ã€‚</span><br>    <span class="hljs-comment"># ç°ä»£ç¡¬ä»¶ï¼ˆGPUã€TPUã€ASICï¼‰é’ˆå¯¹å¿«é€ŸçŸ©é˜µä¹˜æ³•è¿›è¡Œäº†ä¼˜åŒ–ï¼ ^^ (* &gt;&gt; /)</span><br>    <span class="hljs-comment"># å½¢çŠ¶ = (N, FIN) -&gt; (N, 1)ï¼Œå…¶ä¸­ N è¡¨ç¤ºèŠ‚ç‚¹æ•°ï¼ŒFIN è¡¨ç¤ºè¾“å…¥ç‰¹å¾æ•°</span><br>    node_features_sum = np.array(node_features_sparse.<span class="hljs-built_in">sum</span>(-<span class="hljs-number">1</span>))  <span class="hljs-comment"># å¯¹æ¯ä¸ªèŠ‚ç‚¹ç‰¹å¾å‘é‡æ±‚å’Œç‰¹å¾</span><br><br>    <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªé€†çŸ©é˜µï¼ˆè®°ä½ * by 1/x ä¼˜äºï¼ˆæ›´å¿«ï¼‰/ by xï¼‰</span><br>    <span class="hljs-comment"># å½¢çŠ¶ = (N, 1) -&gt; (N)</span><br>    node_features_inv_sum = np.power(node_features_sum, -<span class="hljs-number">1</span>).squeeze()<br><br>    <span class="hljs-comment"># å†æ¬¡æŸäº›å’Œå°†ä¸º 0ï¼Œå› æ­¤ 1/0 å°†ä¸ºæˆ‘ä»¬æä¾› infï¼Œå› æ­¤æˆ‘ä»¬å°†å®ƒä»¬æ›¿æ¢ä¸º 1ï¼Œå®ƒæ˜¯ mul çš„ä¸­æ€§å…ƒç´ </span><br>    node_features_inv_sum[np.isinf(node_features_inv_sum)] = <span class="hljs-number">1.</span><br><br>    <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªå¯¹è§’çŸ©é˜µï¼Œå…¶å¯¹è§’çº¿ä¸Šçš„å€¼æ¥è‡ª node_features_inv_sum</span><br>    diagonal_inv_features_sum_matrix = sp.diags(node_features_inv_sum)<br><br>    <span class="hljs-comment"># æˆ‘ä»¬è¿”å›å½’ä¸€åŒ–çš„ç‰¹å¾ã€‚</span><br>    <span class="hljs-keyword">return</span> diagonal_inv_features_sum_matrix.dot(node_features_sparse)<br><br></code></pre></td></tr></table></figure>

<p>å®ƒåŸºæœ¬ä¸Šä½¿Cora çš„äºŒå…ƒèŠ‚ç‚¹ç‰¹å¾å‘é‡æ€»å’Œä¸º1ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰[1, 0, 1, 0, 1]ï¼ˆCoraçš„ç‰¹å¾å‘é‡æ›´é•¿ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šçœ‹åˆ°ï¼Œä½†æˆ‘ä»¬æš‚æ—¶é‡‡ç”¨â€‹â€‹è¿™ä¸ªï¼‰ï¼Œå®ƒå°†è¢«è½¬æ¢ä¸º[0.33, 0, 0.33, 0, 0.33]. å°±é‚£ä¹ˆç®€å•ã€‚ç†è§£å®é™…çš„å®ç°æ€»æ˜¯æ¯”è¾ƒå›°éš¾ï¼Œä½†ä»æ¦‚å¿µä¸Šè®²ï¼Œè¿™æ˜¯å°èœä¸€ç¢Ÿã€‚</p>
<p>è®©æˆ‘ä»¬å»ºç«‹è¾¹ç´¢å¼•ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">build_edge_index</span>(<span class="hljs-params">adjacency_list_dict, num_of_nodes, add_self_edges=<span class="hljs-literal">True</span></span>):<br>    source_nodes_ids, target_nodes_ids = [], []<br>    seen_edges = <span class="hljs-built_in">set</span>()<br><br>    <span class="hljs-keyword">for</span> src_node, neighboring_nodes <span class="hljs-keyword">in</span> adjacency_list_dict.items():<br>        <span class="hljs-keyword">for</span> trg_node <span class="hljs-keyword">in</span> neighboring_nodes:<br>            <span class="hljs-comment"># if this edge hasn&#x27;t been seen so far we add it to the edge index (coalescing - removing duplicates)</span><br>            <span class="hljs-keyword">if</span> (src_node, trg_node) <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> seen_edges:  <span class="hljs-comment"># it&#x27;d be easy to explicitly remove self-edges (Cora has none..)</span><br>                source_nodes_ids.append(src_node)<br>                target_nodes_ids.append(trg_node)<br><br>                seen_edges.add((src_node, trg_node))<br><br>    <span class="hljs-keyword">if</span> add_self_edges:<br>        source_nodes_ids.extend(np.arange(num_of_nodes))<br>        target_nodes_ids.extend(np.arange(num_of_nodes))<br><br>    <span class="hljs-comment"># shape = (2, E), where E is the number of edges in the graph</span><br>    edge_index = np.row_stack((source_nodes_ids, target_nodes_ids))<br><br>    <span class="hljs-keyword">return</span> edge_index<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªåº”è¯¥ç›¸å½“ç®€å• - æˆ‘ä»¬åªæ˜¯ä»¥è¿™ç§æ ¼å¼ç´¯ç§¯è¾¹ï¼š<br>[[0, 1], [2, 2], â€¦] å…¶ä¸­ [s, t] å…ƒç»„åŸºæœ¬ä¸Šå®šä¹‰äº†èŠ‚ç‚¹sï¼ˆæºï¼‰æŒ‡å‘çš„è¾¹åˆ°èŠ‚ç‚¹tï¼ˆç›®æ ‡ï¼‰ã€‚</p>
<p>å…¶ä»–æµè¡Œçš„æ ¼å¼ï¼ˆåœ¨æºç å¦å¤–ä¸ªå®ç°ä¸­ä½¿ç”¨ï¼‰æ˜¯é‚»æ¥çŸ©é˜µ- ä½†å®ƒä»¬å ç”¨æ›´å¤šçš„å†…å­˜ï¼ˆå‡†ç¡®åœ°è¯´ï¼ŒO(N^2)ï¼Œä¸è¾¹ç¼˜ç´¢å¼•ç»“æ„çš„ O(E) è¿›è¡Œæ¯”è¾ƒï¼‰ã€‚</p>
<p>å¾ˆå¥½ï¼Œæœ€åè®©æˆ‘ä»¬å°è¯•åŠ è½½å®ƒã€‚æˆ‘ä»¬è¿˜åº”è¯¥åˆ†æå½¢çŠ¶â€”â€”è¿™æ€»æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Let&#x27;s just define dummy visualization functions for now - just to stop Python interpreter from complaining!</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_in_out_degree_distributions</span>():<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">visualize_graph</span>():<br>    <span class="hljs-keyword">pass</span><br><br>device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)  <span class="hljs-comment"># checking whether you have a GPU</span><br><br>config = &#123;<br>    <span class="hljs-string">&#x27;dataset_name&#x27;</span>: DatasetType.CORA.name,<br>    <span class="hljs-string">&#x27;should_visualize&#x27;</span>: <span class="hljs-literal">False</span><br>&#125;<br><br>node_features, node_labels, edge_index, train_indices, val_indices, test_indices = load_graph_data(config, device)<br><br><span class="hljs-built_in">print</span>(node_features.shape, node_features.dtype)<br><span class="hljs-built_in">print</span>(node_labels.shape, node_labels.dtype)<br><span class="hljs-built_in">print</span>(edge_index.shape, edge_index.dtype)<br><span class="hljs-built_in">print</span>(train_indices.shape, train_indices.dtype)<br><span class="hljs-built_in">print</span>(val_indices.shape, val_indices.dtype)<br><span class="hljs-built_in">print</span>(test_indices.shape, test_indices.dtype)<br></code></pre></td></tr></table></figure>

<pre><code class="hljs">torch.Size([2708, 1433]) torch.float32
torch.Size([2708]) torch.int64
torch.Size([2, 13264]) torch.int64
torch.Size([140]) torch.int64
torch.Size([500]) torch.int64
torch.Size([1000]) torch.int64


/var/folders/f0/812mfv7x63vbytjs3yf4gxtc0000gn/T/ipykernel_16269/2448994618.py:6: DeprecationWarning: Please use `csr_matrix` from the `scipy.sparse` namespace, the `scipy.sparse.csr` namespace is deprecated.
  data = pickle.load(file)
</code></pre>
<p>å¥½çš„ï¼åˆ†æå½¢çŠ¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li>Coraæœ‰2708ä¸ªèŠ‚ç‚¹</li>
<li>æ¯ä¸ªèŠ‚ç‚¹æœ‰ 1433 ä¸ªç‰¹å¾ï¼ˆæŸ¥çœ‹data_loading.pyäº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼‰</li>
<li>æˆ‘ä»¬æœ‰ 13264 æ¡è¾¹ï¼ï¼ˆåŒ…æ‹¬è‡ªèº«è¾¹ï¼‰</li>
<li>æˆ‘ä»¬æœ‰140ä¸ªè®­ç»ƒèŠ‚ç‚¹</li>
<li>æˆ‘ä»¬æœ‰ 500 ä¸ªéªŒè¯èŠ‚ç‚¹</li>
<li>æˆ‘ä»¬æœ‰1000ä¸ªæµ‹è¯•èŠ‚ç‚¹<br>æ­¤å¤–ï¼Œå‡ ä¹æ‰€æœ‰æ•°æ®éƒ½æ˜¯ int 64 ç±»å‹ã€‚ä¸ºä»€ä¹ˆï¼Ÿè¿™æ˜¯ PyTorch å¼ºåŠ ç»™æˆ‘ä»¬çš„ä¸€ä¸ªé™åˆ¶ã€‚æŸå¤±å‡½æ•°nn.CrossEntropyLosså’Œindex_selectå‡½æ•°éœ€è¦ torch.long ï¼ˆå³ 64 ä½æ•´æ•°ï¼‰-æ‰€ä»¥è¿™æ ·ã€‚</li>
</ol>
<ul>
<li><code>node_labels</code>æ˜¯ int64 å› ä¸º<code>nn.CrossEntropyLoss</code></li>
<li>å…¶ä»–å˜é‡æ˜¯ int64 å› ä¸º<code>index_select</code><br>åœ¨â€œæ—æ³¨â€ä¸­ï¼Œéšç€æ‚¨çš„è¿›å±•æµ‹è¯•æ‚¨çš„ä»£ç æ€»æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚</li>
</ul>
<p>æ•°æ®åŠ è½½ä¸æ­¤ç¬”è®°æœ¬çš„å…¶ä½™éƒ¨åˆ†å®Œå…¨æ­£äº¤ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç‹¬ç«‹æµ‹è¯•å®ƒï¼Œå¹¶ç¡®ä¿å½¢çŠ¶å’Œæ•°æ®ç±»å‹æœ‰æ„ä¹‰ã€‚æˆ‘åœ¨å¼€å‘åƒè¿™æ ·çš„é¡¹ç›®ï¼ˆä»¥åŠä¸€èˆ¬æƒ…å†µä¸‹ï¼‰æ—¶ä½¿ç”¨è¿™ä¸€ç­–ç•¥ã€‚</p>
<p>æˆ‘ä»æ•°æ®å¼€å§‹ï¼Œæ·»åŠ åŠ è½½åŠŸèƒ½ï¼Œæ·»åŠ ä¸€äº›å¯è§†åŒ–ï¼Œç„¶åæˆ‘é€šå¸¸æ‰å¼€å§‹å¼€å‘æ·±åº¦å­¦ä¹ æ¨¡å‹æœ¬èº«ã€‚</p>
<p>å¯è§†åŒ–æ˜¯ä¸€ä¸ªå·¨å¤§çš„å¥½å¤„ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬å¼€å‘å®ƒä»¬ã€‚</p>
<h1 id="å¯è§†åŒ–æ•°æ®ğŸ”®ğŸ‘“"><a href="#å¯è§†åŒ–æ•°æ®ğŸ”®ğŸ‘“" class="headerlink" title="å¯è§†åŒ–æ•°æ®ğŸ”®ğŸ‘“"></a>å¯è§†åŒ–æ•°æ®ğŸ”®ğŸ‘“</h1><p>è®©æˆ‘ä»¬é¦–å…ˆäº†è§£ Cora ä¸­èŠ‚ç‚¹çš„åº¦åˆ†å¸ƒ - å³èŠ‚ç‚¹æœ‰å¤šå°‘æ¡è¾“å…¥&#x2F;è¾“å‡ºè¾¹ï¼Œè¿™æ˜¯å›¾è¿é€šæ€§çš„æŸç§åº¦é‡ã€‚</p>
<p>è¿è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_in_out_degree_distributions</span>(<span class="hljs-params">edge_index, num_of_nodes, dataset_name</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        æ³¨æ„ï¼šä½¿ç”¨ igraph/networkx ç­‰å·¥å…·å¯ä»¥è½»æ¾è¿›è¡Œå„ç§å¼ºå¤§çš„ç½‘ç»œåˆ†æã€‚</span><br><span class="hljs-string">        æˆ‘é€‰æ‹©åœ¨æ­¤å¤„æ˜¾å¼è®¡ç®—ä»…èŠ‚ç‚¹åº¦é‡ç»Ÿè®¡ï¼Œä½†å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥æ·±å…¥ç ”ç©¶å¹¶è®¡ç®—å›¾ç›´å¾„ã€ä¸‰è§’å½¢æ•°é‡ä»¥åŠè®¸å¤šå…¶ä»–ç½‘ç»œåˆ†æé¢†åŸŸçš„æ¦‚å¿µã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(edge_index, torch.Tensor):<br>        edge_index = edge_index.cpu().numpy()<br>        <br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(edge_index, np.ndarray), <span class="hljs-string">f&#x27;Expected NumPy array got <span class="hljs-subst">&#123;<span class="hljs-built_in">type</span>(edge_index)&#125;</span>.&#x27;</span><br><br>    <span class="hljs-comment"># å­˜å‚¨æ¯ä¸ªèŠ‚ç‚¹çš„è¾“å…¥å’Œè¾“å‡ºåº¦ï¼ˆå¯¹äºæ— å‘å›¾å¦‚ Coraï¼Œå®ƒä»¬æ˜¯ç›¸åŒçš„ï¼‰</span><br>    in_degrees = np.zeros(num_of_nodes, dtype=<span class="hljs-built_in">int</span>)<br>    out_degrees = np.zeros(num_of_nodes, dtype=<span class="hljs-built_in">int</span>)<br><br>    <span class="hljs-comment"># è¾¹ç´¢å¼•å½¢çŠ¶ = (2, E)ï¼Œç¬¬ä¸€è¡ŒåŒ…å«æºèŠ‚ç‚¹ï¼Œç¬¬äºŒè¡ŒåŒ…å«ç›®æ ‡/æ±‡èŠ‚ç‚¹</span><br>    <span class="hljs-comment"># æœ¯è¯­è¯´æ˜ï¼šæºèŠ‚ç‚¹æŒ‡å‘ç›®æ ‡/æ±‡èŠ‚ç‚¹</span><br>    num_of_edges = edge_index.shape[<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">for</span> cnt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_of_edges):<br>        source_node_id = edge_index[<span class="hljs-number">0</span>, cnt]<br>        target_node_id = edge_index[<span class="hljs-number">1</span>, cnt]<br><br>        out_degrees[source_node_id] += <span class="hljs-number">1</span>  <span class="hljs-comment"># æºèŠ‚ç‚¹æŒ‡å‘å…¶ä»–èŠ‚ç‚¹ -&gt; å¢åŠ å…¶å‡ºåº¦</span><br>        in_degrees[target_node_id] += <span class="hljs-number">1</span>  <span class="hljs-comment"># ç±»ä¼¼åœ°</span><br><br>    hist = np.zeros(np.<span class="hljs-built_in">max</span>(out_degrees) + <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">for</span> out_degree <span class="hljs-keyword">in</span> out_degrees:<br>        hist[out_degree] += <span class="hljs-number">1</span><br><br>    fig = plt.figure(figsize=(<span class="hljs-number">12</span>,<span class="hljs-number">8</span>), dpi=<span class="hljs-number">100</span>)  <span class="hljs-comment"># å¦åˆ™åœ¨ Jupyter Notebook ä¸­å›¾è¡¨ä¼šå¾ˆå°</span><br>    fig.subplots_adjust(hspace=<span class="hljs-number">0.6</span>)<br><br>    plt.subplot(<span class="hljs-number">311</span>)<br>    plt.plot(in_degrees, color=<span class="hljs-string">&#x27;red&#x27;</span>)<br>    plt.xlabel(<span class="hljs-string">&#x27;node id&#x27;</span>); plt.ylabel(<span class="hljs-string">&#x27;in-degree count&#x27;</span>); plt.title(<span class="hljs-string">&#x27;ä¸åŒèŠ‚ç‚¹ id çš„è¾“å…¥åº¦&#x27;</span>)<br><br>    plt.subplot(<span class="hljs-number">312</span>)<br>    plt.plot(out_degrees, color=<span class="hljs-string">&#x27;green&#x27;</span>)<br>    plt.xlabel(<span class="hljs-string">&#x27;node id&#x27;</span>); plt.ylabel(<span class="hljs-string">&#x27;out-degree count&#x27;</span>); plt.title(<span class="hljs-string">&#x27;ä¸åŒèŠ‚ç‚¹ id çš„è¾“å‡ºåº¦&#x27;</span>)<br><br>    plt.subplot(<span class="hljs-number">313</span>)<br>    plt.plot(hist, color=<span class="hljs-string">&#x27;blue&#x27;</span>)<br>    plt.xlabel(<span class="hljs-string">&#x27;node degree&#x27;</span>)<br>    plt.ylabel(<span class="hljs-string">&#x27;ç»™å®šå‡ºåº¦çš„èŠ‚ç‚¹æ•°é‡&#x27;</span>) <br>    plt.title(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;dataset_name&#125;</span> æ•°æ®é›†çš„èŠ‚ç‚¹å‡ºåº¦åˆ†å¸ƒ&#x27;</span>)<br>    plt.xticks(np.arange(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(hist), <span class="hljs-number">5.0</span>))<br><br>    plt.grid(<span class="hljs-literal">True</span>)<br>    plt.show()<br><br></code></pre></td></tr></table></figure>

<p>å¤ªæ£’äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬å¯è§†åŒ– Cora çš„åº¦åˆ†å¸ƒï¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">num_of_nodes = <span class="hljs-built_in">len</span>(node_labels)<br>plot_in_out_degree_distributions(edge_index, num_of_nodes, config[<span class="hljs-string">&#x27;dataset_name&#x27;</span>])<br></code></pre></td></tr></table></figure>


<p><img src="https://ptpimg.me/92t60u.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"></p>
<p>æ‚¨å¯ä»¥ç«‹å³æ³¨æ„åˆ°ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>å‰2ä¸ªå›¾æ˜¯ç›¸åŒçš„ï¼Œå› ä¸ºæˆ‘ä»¬å°† Cora è§†ä¸ºæ— å‘å›¾ï¼ˆå³ä½¿å®ƒè‡ªç„¶åº”è¯¥å»ºæ¨¡ä¸ºæœ‰å‘å›¾ï¼‰</li>
<li>æŸäº›èŠ‚ç‚¹å…·æœ‰å¤§é‡è¾¹ï¼ˆä¸­é—´çš„å³°å€¼ï¼‰ï¼Œä½†å¤§å¤šæ•°èŠ‚ç‚¹çš„è¾¹è¦å°‘å¾—å¤š</li>
<li>ç¬¬ä¸‰å¼ å›¾ä»¥ç›´æ–¹å›¾çš„å½¢å¼å¾ˆå¥½åœ°å¯è§†åŒ–äº†è¿™ä¸€ç‚¹ - å¤§å¤šæ•°èŠ‚ç‚¹åªæœ‰2-5æ¡è¾¹ï¼ˆå› æ­¤å³°å€¼ä½äºæœ€å·¦ä¾§ï¼‰<br>å¥½å§ï¼Œæˆ‘ä»¬å¼€å§‹å¯¹ Cora æœ‰äº†ä¸€äº›æœ‰ä»·å€¼çš„è§è§£ï¼Œè®©æˆ‘ä»¬ç»§ç»­è¿›ä¸€æ­¥ï¼Œä»å­—é¢ä¸Šæƒ³è±¡&#x2F;çœ‹åˆ° Coraã€‚</li>
</ul>
<p>ä¸‹é¢çš„å•å…ƒæ ¼å°†ç»˜åˆ¶ Coraï¼Œè¿è¡Œå®ƒã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">è¯·å‚é˜…æ­¤åšå®¢ä»¥äº†è§£å¯ç”¨çš„å›¾å½¢å¯è§†åŒ–å·¥å…·ï¼š</span><br><span class="hljs-string">  https://towardsdatascience.com/large-graph-visualization-tools-and-approaches-2b8758a1cd59</span><br><span class="hljs-string"></span><br><span class="hljs-string">åŸºæœ¬ä¸Šï¼Œå–å†³äºæ‚¨çš„å›¾å½¢å¤§å°ï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›æ¯” igraph æ›´å¥½çš„ç»˜å›¾å·¥å…·ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">æ³¨æ„ï¼šä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä¸å¾—ä¸å°†æ­¤å‡½æ•°æ‰å¹³åŒ–ï¼Œå› ä¸º igraph åœ¨ Jupyter Notebook ä¸­é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œ</span><br><span class="hljs-string">æˆ‘ä»¬åªä¼šåœ¨è¿™é‡Œè°ƒç”¨å®ƒï¼Œæ‰€ä»¥æ²¡å…³ç³»ï¼</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>dataset_name = config[<span class="hljs-string">&#x27;dataset_name&#x27;</span>]<br>visualization_tool=GraphVisualizationTool.IGRAPH<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(edge_index, torch.Tensor):<br>    edge_index_np = edge_index.cpu().numpy()<br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(node_labels, torch.Tensor):<br>    node_labels_np = node_labels.cpu().numpy()<br><br>num_of_nodes = <span class="hljs-built_in">len</span>(node_labels_np)<br>edge_index_tuples = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">zip</span>(edge_index_np[<span class="hljs-number">0</span>, :], edge_index_np[<span class="hljs-number">1</span>, :]))  <span class="hljs-comment"># igraph è¦æ±‚è¿™ç§æ ¼å¼</span><br><br><span class="hljs-comment"># æ„å»º igraph å›¾</span><br>ig_graph = ig.Graph()<br>ig_graph.add_vertices(num_of_nodes)<br>ig_graph.add_edges(edge_index_tuples)<br><br><span class="hljs-comment"># å‡†å¤‡å¯è§†åŒ–è®¾ç½®å­—å…¸</span><br>visual_style = &#123;<br>    <span class="hljs-string">&quot;bbox&quot;</span>: (<span class="hljs-number">700</span>, <span class="hljs-number">700</span>),<br>    <span class="hljs-string">&quot;margin&quot;</span>: <span class="hljs-number">5</span>,<br>&#125;<br><br><span class="hljs-comment"># æˆ‘é€‰æ‹©è¾¹çš„åšåº¦ä¸é€šè¿‡æˆ‘ä»¬å›¾ä¸­æŸä¸ªè¾¹çš„æœ€çŸ­è·¯å¾„ï¼ˆæµ‹åœ°çº¿ï¼‰çš„æ•°é‡æˆæ¯”ä¾‹ï¼ˆedge_betweenness å‡½æ•°ï¼Œä¸€ä¸ªç®€å•çš„ ad hoc å¯å‘å¼ï¼‰</span><br><br><span class="hljs-comment"># line1ï¼šæˆ‘ä½¿ç”¨æ—¥å¿—ï¼Œå¦åˆ™ä¸€äº›è¾¹ä¼šå¤ªåšï¼Œè€Œå…¶ä»–è¾¹æ ¹æœ¬ä¸æ˜æ˜¾</span><br><span class="hljs-comment"># edge_betweenness è¿”å› &lt; 1 å¯¹äºæŸäº›è¾¹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä½¿ç”¨ clip ä½œä¸º log å¯¹äºé‚£äº›è¾¹æ¥è¯´æ˜¯è´Ÿçš„</span><br><span class="hljs-comment"># line2ï¼šå½’ä¸€åŒ–ï¼Œä½¿æœ€åšçš„è¾¹ä¸º 1ï¼Œå¦åˆ™è¾¹åœ¨å›¾è¡¨ä¸Šçœ‹èµ·æ¥å¤ªåš</span><br><span class="hljs-comment"># line3ï¼šè¿™é‡Œçš„æƒ³æ³•æ˜¯è®©æœ€å¼ºçš„è¾¹ç¼˜ä¿æŒæ¯”å…¶ä»–è¾¹ç¼˜æ›´å¼ºï¼Œ6 åˆšåˆšå¥½ï¼Œä¸è¦çº ç»“äºæ­¤</span><br><br>edge_weights_raw = np.clip(np.log(np.asarray(ig_graph.edge_betweenness())+<span class="hljs-number">1e-16</span>), a_min=<span class="hljs-number">0</span>, a_max=<span class="hljs-literal">None</span>)<br>edge_weights_raw_normalized = edge_weights_raw / np.<span class="hljs-built_in">max</span>(edge_weights_raw)<br>edge_weights = [w**<span class="hljs-number">6</span> <span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> edge_weights_raw_normalized]<br>visual_style[<span class="hljs-string">&quot;edge_width&quot;</span>] = edge_weights<br><br><span class="hljs-comment"># é¡¶ç‚¹å¤§å°çš„ç®€å•å¯å‘å¼ã€‚å¤§å° ~ (åº¦/4)ï¼ˆæˆ‘å°è¯•äº† log å’Œ sqrt ä¹Ÿå–å¾—äº†å¾ˆå¥½çš„æ•ˆæœï¼‰</span><br>visual_style[<span class="hljs-string">&quot;vertex_size&quot;</span>] = [deg / <span class="hljs-number">4</span> <span class="hljs-keyword">for</span> deg <span class="hljs-keyword">in</span> ig_graph.degree()]<br><br><span class="hljs-comment"># Cora ç‰¹æœ‰çš„éƒ¨åˆ†ï¼Œå› ä¸º Cora æœ‰ 7 ä¸ªæ ‡ç­¾</span><br><span class="hljs-keyword">if</span> dataset_name.lower() == DatasetType.CORA.name.lower():<br>    visual_style[<span class="hljs-string">&quot;vertex_color&quot;</span>] = [cora_label_to_color_map[label] <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> node_labels_np]<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;è¯·éšæ„ä¸ºæ‚¨çš„ç‰¹å®šæ•°æ®é›†æ·»åŠ è‡ªå®šä¹‰é…è‰²æ–¹æ¡ˆã€‚ä½¿ç”¨ igraph é»˜è®¤é…è‰²ã€‚&#x27;</span>)<br><br><span class="hljs-comment"># è®¾ç½®å¸ƒå±€ - å›¾è¡¨åœ¨ 2D å›¾è¡¨ä¸Šå‘ˆç°çš„æ–¹å¼ã€‚å›¾å½¢ç»˜åˆ¶æœ¬èº«æ˜¯ä¸€ä¸ªå­é¢†åŸŸï¼</span><br><span class="hljs-comment"># æˆ‘ä½¿ç”¨â€œKamada Kawaiâ€åŠ›å¯¼å‘æ–¹æ³•ï¼Œè¿™ç»„æ–¹æ³•åŸºäºç‰©ç†ç³»ç»Ÿæ¨¡æ‹Ÿã€‚</span><br><span class="hljs-comment"># ï¼ˆlayout_drl ä¹Ÿä¸º Cora æä¾›äº†ä¸é”™çš„ç»“æœï¼‰</span><br>visual_style[<span class="hljs-string">&quot;layout&quot;</span>] = ig_graph.layout_kamada_kawai()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;æ­£åœ¨ç»˜åˆ¶ç»“æœ...ï¼ˆå¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼‰ã€‚&#x27;</span>)<br>ig.plot(ig_graph, **visual_style)<br><br><span class="hljs-comment"># è¿™ä¸ªç½‘ç«™æœ‰ä¸€äº›å¾ˆæ£’çš„å¯è§†åŒ–æ•ˆæœï¼Œè¯·æŸ¥çœ‹ï¼š</span><br><span class="hljs-comment"># http://networkrepository.com/graphvis.php?d=./data/gsm50/labeled/cora.edges</span><br><br></code></pre></td></tr></table></figure>

<pre><code class="hljs">æ­£åœ¨ç»˜åˆ¶ç»“æœ...ï¼ˆå¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼‰ã€‚
</code></pre>
<p><img src="https://ptpimg.me/s94oh0.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"></p>
<p>å°è¯•ä½¿ç”¨visual_style[â€œbboxâ€]è®¾ç½®åˆ°(3000, 3000)å’Œåœ¨vertex_sizeç”¨ &#x2F; 2è¿è¡Œï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªå·¨å·¨å·¨å¤§è€ŒæƒŠäººçš„ç»˜å›¾ï¼ˆCå¤„ç† igraph åé¢çš„ç»˜å›¾ï¼Œæ‰€ä»¥å®ƒè‡³å°‘åœ¨æˆ‘çš„æœºå™¨ä¸Šç›¸å½“å¿« - å½“ä½ æ»šåŠ¨å®ƒæ—¶æœ‰ä¸€äº›è½»å¾®çš„æ»åï¼‰ã€‚</p>
<p>å¥½çš„ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å¯è§†åŒ–å¹¶ç†è§£äº†æˆ‘ä»¬çš„æ•°æ®ã€‚è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„é‡Œç¨‹ç¢‘ï¼Œæ‰€ä»¥è¯·æ‹æ‹è‡ªå·±çš„è‚©è†€ã€‚ğŸ†ğŸ‚ğŸµ</p>
<p>æˆ‘ä»¬å·²ç»è§£é”äº† 2 çº§ï¼ˆGATæ¨¡å‹ğŸ¦„ï¼‰ã€‚ğŸ˜</p>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬äº†è§£è¿™ä¸ªæ¨¡å‹ï¼</p>
<h1 id="ç¬¬-2-éƒ¨åˆ†ï¼šäº†è§£-GAT-çš„å†…éƒ¨è¿ä½œæ–¹å¼"><a href="#ç¬¬-2-éƒ¨åˆ†ï¼šäº†è§£-GAT-çš„å†…éƒ¨è¿ä½œæ–¹å¼" class="headerlink" title="ç¬¬ 2 éƒ¨åˆ†ï¼šäº†è§£ GAT çš„å†…éƒ¨è¿ä½œæ–¹å¼"></a>ç¬¬ 2 éƒ¨åˆ†ï¼šäº†è§£ GAT çš„å†…éƒ¨è¿ä½œæ–¹å¼</h1><p>GATé¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé«˜çº§ç±»ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­ä»GatLayerå¯¹è±¡æ„å»ºã€‚</p>
<p>å®ƒåŸºæœ¬ä¸Šåªæ˜¯å°†å±‚å †å åˆ° nn.Sequential å¯¹è±¡ä¸­ï¼Œæ­¤å¤–ï¼Œç”±äº nn.Sequential éœ€è¦å•ä¸ªè¾“å…¥ï¼ˆå¹¶ä¸”å®ƒæœ‰ä¸€ä¸ªè¾“å‡ºï¼‰ï¼Œæˆ‘åªæ˜¯å°†æ•°æ®ï¼ˆç‰¹å¾ã€è¾¹ç¼˜ç´¢å¼•ï¼‰æ‰“åŒ…åˆ°ä¸€ä¸ªå…ƒç»„ä¸­ - çº¯è¯­æ³•ç³–ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">from</span> torch.optim <span class="hljs-keyword">import</span> Adam<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GAT</span>(torch.nn.Module):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    æœ€æœ‰è¶£å’Œæœ€éš¾çš„å®ç°æ˜¯å®ç°ï¼ƒ3ã€‚</span><br><span class="hljs-string">    Imp1å’Œimp2åœ¨ç»†èŠ‚ä¸Šæœ‰æ‰€ä¸åŒï¼Œä½†åŸºæœ¬ä¸Šæ˜¯ç›¸åŒçš„ä¸œè¥¿ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">    å› æ­¤ï¼Œæˆ‘å°†åœ¨æœ¬ç¬”è®°æœ¬ä¸­ä¸“æ³¨äºimpï¼ƒ3ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_of_layers, num_heads_per_layer, num_features_per_layer, add_skip_connection=<span class="hljs-literal">True</span>, bias=<span class="hljs-literal">True</span>,</span><br><span class="hljs-params">                 dropout=<span class="hljs-number">0.6</span>, log_attention_weights=<span class="hljs-literal">False</span></span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br>        <span class="hljs-keyword">assert</span> num_of_layers == <span class="hljs-built_in">len</span>(num_heads_per_layer) == <span class="hljs-built_in">len</span>(num_features_per_layer) - <span class="hljs-number">1</span>, <span class="hljs-string">f&#x27;è¾“å…¥æœ‰æ•ˆçš„æ¶æ„å‚æ•°ã€‚&#x27;</span><br><br>        num_heads_per_layer = [<span class="hljs-number">1</span>] + num_heads_per_layer  <span class="hljs-comment"># æŠ€å·§-è¿™æ ·æˆ‘å¯ä»¥å¾ˆå¥½åœ°åˆ›å»ºä¸‹é¢çš„GATå±‚</span><br><br>        gat_layers = []  <span class="hljs-comment"># æ”¶é›†GATå±‚</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_of_layers):<br>            layer = GATLayer(<br>                num_in_features=num_features_per_layer[i] * num_heads_per_layer[i],  <span class="hljs-comment"># è¿æ¥çš„ç»“æœ</span><br>                num_out_features=num_features_per_layer[i+<span class="hljs-number">1</span>],<br>                num_of_heads=num_heads_per_layer[i+<span class="hljs-number">1</span>],<br>                concat=<span class="hljs-literal">True</span> <span class="hljs-keyword">if</span> i &lt; num_of_layers - <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">False</span>,  <span class="hljs-comment"># æœ€åä¸€ä¸ªGATå±‚æ‰§è¡Œå¹³å‡å€¼ï¼Œå…¶ä»–å±‚æ‰§è¡Œè¿æ¥</span><br>                activation=nn.ELU() <span class="hljs-keyword">if</span> i &lt; num_of_layers - <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,  <span class="hljs-comment"># æœ€åä¸€å±‚åªè¾“å‡ºåŸå§‹åˆ†æ•°</span><br>                dropout_prob=dropout,<br>                add_skip_connection=add_skip_connection,<br>                bias=bias,<br>                log_attention_weights=log_attention_weights<br>            )<br>            gat_layers.append(layer)<br><br>        <span class="hljs-variable language_">self</span>.gat_net = nn.Sequential(<br>            *gat_layers,<br>        )<br><br>    <span class="hljs-comment"># æ•°æ®åªæ˜¯ä¸€ä¸ªï¼ˆin_nodes_featuresï¼Œedge_indexï¼‰å…ƒç»„ï¼Œæˆ‘å¿…é¡»è¿™æ ·åšæ˜¯å› ä¸ºnn.Sequentialï¼š</span><br>    <span class="hljs-comment"># https://discuss.pytorch.org/t/forward-takes-2-positional-arguments-but-3-were-given-for-nn-sqeuential-with-linear-layers/65698</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.gat_net(data)<br><br></code></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œæœ‰è¶£çš„éƒ¨åˆ†è®©æˆ‘ä»¬å®šä¹‰å›¾å±‚ã€‚</p>
<p>æˆ‘ä¸è®¤ä¸ºç”¨æ–‡å­—æ¥è§£é‡Šå®ƒï¼Œæ¯”ä½ èŠ±æ—¶é—´æ¶ˆåŒ–ä»£ç å’Œæ³¨é‡Šæ›´å¥½ã€‚</p>
<p>åœ¨ä½ å¼€å§‹æµªè´¹æ—¶é—´å°è¯•â€œä»å¤´å¼€å§‹â€å¼„æ¸…æ¥šä¹‹å‰ï¼Œå¯ä»¥å…ˆè§‚çœ‹ä½œè€…åœ¨ GAT ä¸Šçš„è§†é¢‘ã€‚æ‰‹å¤´æœ‰ä¸€äº›ç†è®ºèƒŒæ™¯æ€»æ˜¯å¥½çš„ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GATLayer</span>(torch.nn.Module):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    å®ç° #3 å—åˆ° PyTorch Geometric å¯å‘ï¼šhttps://github.com/rusty1s/pytorch_geometric</span><br><span class="hljs-string"></span><br><span class="hljs-string">    ä½†æ˜¯ï¼Œè¿™é‡Œçš„å®ç°åº”è¯¥æ›´å®¹æ˜“ç†è§£ï¼ï¼ˆå¹¶ä¸”æ€§èƒ½ç›¸ä¼¼ï¼‰</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <br>    <span class="hljs-comment"># æˆ‘ä»¬ä¼šåœ¨è®¸å¤šå‡½æ•°ä¸­ä½¿ç”¨è¿™äº›å¸¸é‡ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæå–ä¸ºæˆå‘˜å­—æ®µ</span><br>    src_nodes_dim = <span class="hljs-number">0</span>  <span class="hljs-comment"># è¾¹ç´¢å¼•ä¸­æºèŠ‚ç‚¹çš„ä½ç½®</span><br>    trg_nodes_dim = <span class="hljs-number">1</span>  <span class="hljs-comment"># è¾¹ç´¢å¼•ä¸­ç›®æ ‡èŠ‚ç‚¹çš„ä½ç½®</span><br><br>    <span class="hljs-comment"># åœ¨å½’çº³è®¾ç½®ä¸­ï¼Œè¿™äº›å¯èƒ½ä¼šæ”¹å˜ - æš‚æ—¶ä¿ç•™è¿™æ ·çš„è®¾ç½®ï¼ˆæœªæ¥å¯èƒ½ä¸é€‚ç”¨ï¼‰</span><br>    nodes_dim = <span class="hljs-number">0</span>      <span class="hljs-comment"># èŠ‚ç‚¹ç»´åº¦ï¼ˆè½´åœ¨å¼ é‡ä¸­å¯èƒ½æ˜¯ä¸€ä¸ªæ›´ç†Ÿæ‚‰çš„æœ¯è¯­ï¼ŒèŠ‚ç‚¹ç»´åº¦æ˜¯&quot;N&quot;çš„ä½ç½®ï¼‰</span><br>    head_dim = <span class="hljs-number">1</span>       <span class="hljs-comment"># æ³¨æ„åŠ›å¤´ç»´åº¦</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_in_features, num_out_features, num_of_heads, concat=<span class="hljs-literal">True</span>, activation=nn.ELU(<span class="hljs-params"></span>),</span><br><span class="hljs-params">                 dropout_prob=<span class="hljs-number">0.6</span>, add_skip_connection=<span class="hljs-literal">True</span>, bias=<span class="hljs-literal">True</span>, log_attention_weights=<span class="hljs-literal">False</span></span>):<br><br>        <span class="hljs-built_in">super</span>().__init__()<br><br>        <span class="hljs-variable language_">self</span>.num_of_heads = num_of_heads<br>        <span class="hljs-variable language_">self</span>.num_out_features = num_out_features<br>        <span class="hljs-variable language_">self</span>.concat = concat  <span class="hljs-comment"># æ˜¯å¦åº”è¯¥è¿æ¥è¿˜æ˜¯å¹³å‡æ³¨æ„åŠ›å¤´</span><br>        <span class="hljs-variable language_">self</span>.add_skip_connection = add_skip_connection<br><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># å¯è®­ç»ƒæƒé‡ï¼šçº¿æ€§æŠ•å½±çŸ©é˜µï¼ˆåœ¨è®ºæ–‡ä¸­è¡¨ç¤ºä¸º&quot;W&quot;ï¼‰ã€æ³¨æ„åŠ›ç›®æ ‡/æºï¼ˆåœ¨è®ºæ–‡ä¸­è¡¨ç¤ºä¸º&quot;a&quot;ï¼‰å’Œåå·®ï¼ˆåœ¨è®ºæ–‡ä¸­æœªæåˆ°ï¼Œä½†åœ¨å®˜æ–¹GATå­˜å‚¨åº“ä¸­å­˜åœ¨ï¼‰</span><br>        <span class="hljs-comment">#</span><br><br>        <span class="hljs-comment"># å¯ä»¥å°†è¿™ä¸ªçŸ©é˜µè§†ä¸º num_of_heads ä¸ªç‹¬ç«‹çš„ W çŸ©é˜µ</span><br>        <span class="hljs-variable language_">self</span>.linear_proj = nn.Linear(num_in_features, num_of_heads * num_out_features, bias=<span class="hljs-literal">False</span>)<br><br>        <span class="hljs-comment"># åœ¨æˆ‘ä»¬è¿æ¥ç›®æ ‡èŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹ iï¼‰å’ŒæºèŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹ jï¼‰ä¹‹åï¼Œæˆ‘ä»¬åº”ç”¨â€œåŠ æ³•â€è¯„åˆ†å‡½æ•°</span><br>        <span class="hljs-comment"># å®ƒç»™æˆ‘ä»¬æœªæ ‡å‡†åŒ–çš„åˆ†æ•° &quot;e&quot;ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ†å‰² &quot;a&quot; å‘é‡ - ä½†è¯­ä¹‰ä¿æŒä¸å˜ã€‚</span><br>        <span class="hljs-comment"># åŸºæœ¬ä¸Šï¼Œä¸æ‰§è¡Œ [x, y]ï¼ˆè¿æ¥ï¼Œx/y æ˜¯èŠ‚ç‚¹ç‰¹å¾å‘é‡ï¼‰å’Œä¸ &quot;a&quot; çš„ç‚¹ç§¯ä¸åŒï¼Œ</span><br>        <span class="hljs-comment"># æˆ‘ä»¬åˆ†åˆ«å¯¹ x å’Œ &quot;a_left&quot; è¿›è¡Œç‚¹ç§¯ï¼Œå¯¹ y å’Œ &quot;a_right&quot; è¿›è¡Œç‚¹ç§¯ï¼Œç„¶åå°†å®ƒä»¬ç›¸åŠ </span><br>        <span class="hljs-variable language_">self</span>.scoring_fn_target = nn.Parameter(torch.Tensor(<span class="hljs-number">1</span>, num_of_heads, num_out_features))<br>        <span class="hljs-variable language_">self</span>.scoring_fn_source = nn.Parameter(torch.Tensor(<span class="hljs-number">1</span>, num_of_heads, num_out_features))<br><br>        <span class="hljs-comment"># åœ¨ GAT ä¸­åç½®ç»å¯¹ä¸æ˜¯å…³é”®çš„ - éšæ—¶å®éªŒï¼ˆæˆ‘åœ¨è¿™ä¸ªé—®é¢˜ä¸Šå‘ä¸»è¦ä½œè€… Petar è¯¢é—®è¿‡ï¼‰</span><br>        <span class="hljs-keyword">if</span> bias <span class="hljs-keyword">and</span> concat:<br>            <span class="hljs-variable language_">self</span>.bias = nn.Parameter(torch.Tensor(num_of_heads * num_out_features))<br>        <span class="hljs-keyword">elif</span> bias <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> concat:<br>            <span class="hljs-variable language_">self</span>.bias = nn.Parameter(torch.Tensor(num_out_features))<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.register_parameter(<span class="hljs-string">&#x27;bias&#x27;</span>, <span class="hljs-literal">None</span>)<br><br>        <span class="hljs-keyword">if</span> add_skip_connection:<br>            <span class="hljs-variable language_">self</span>.skip_proj = nn.Linear(num_in_features, num_of_heads * num_out_features, bias=<span class="hljs-literal">False</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-variable language_">self</span>.register_parameter(<span class="hljs-string">&#x27;skip_proj&#x27;</span>, <span class="hljs-literal">None</span>)<br><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># å¯è®­ç»ƒæƒé‡ç»“æŸ</span><br>        <span class="hljs-comment">#</span><br><br>        <span class="hljs-variable language_">self</span>.leakyReLU = nn.LeakyReLU(<span class="hljs-number">0.2</span>)  <span class="hljs-comment"># ä½¿ç”¨ 0.2ï¼Œå°±åƒåœ¨è®ºæ–‡ä¸­ä¸€æ ·ï¼Œä¸éœ€è¦å…¬å¼€æ¯ä¸ªè®¾ç½®</span><br>        <span class="hljs-variable language_">self</span>.activation = activation<br>        <span class="hljs-comment"># å¯èƒ½ä¸æ˜¯æœ€å¥½çš„è®¾è®¡ï¼Œä½†æˆ‘åœ¨ 3 ä¸ªä½ç½®ä½¿ç”¨ç›¸åŒçš„æ¨¡å—ï¼Œç”¨äºç‰¹å¾æŠ•å½±ä¹‹å‰/ä¹‹åå’Œæ³¨æ„åŠ›ç³»æ•°ã€‚</span><br>        <span class="hljs-comment"># å°±åŠŸèƒ½è€Œè¨€ï¼Œå®ƒä¸ä½¿ç”¨ç‹¬ç«‹æ¨¡å—æ˜¯ç›¸åŒçš„ã€‚</span><br>        <span class="hljs-variable language_">self</span>.dropout = nn.Dropout(p=dropout_prob)<br><br>        <span class="hljs-variable language_">self</span>.log_attention_weights = log_attention_weights  <span class="hljs-comment"># æ˜¯å¦åº”è®°å½•æ³¨æ„åŠ›æƒé‡</span><br>        <span class="hljs-variable language_">self</span>.attention_weights = <span class="hljs-literal">None</span>  <span class="hljs-comment"># ç”¨äºåç»­å¯è§†åŒ–ç›®çš„ï¼Œæˆ‘åœ¨è¿™é‡Œç¼“å­˜æƒé‡</span><br><br>        <span class="hljs-variable language_">self</span>.init_params()<br>        <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># æ­¥éª¤ 1ï¼šçº¿æ€§æŠ•å½± + æ­£åˆ™åŒ–</span><br>        <span class="hljs-comment">#</span><br><br>        in_nodes_features, edge_index = data  <span class="hljs-comment"># è§£åŒ…æ•°æ®</span><br>        num_of_nodes = in_nodes_features.shape[<span class="hljs-variable language_">self</span>.nodes_dim]<br>        <span class="hljs-keyword">assert</span> edge_index.shape[<span class="hljs-number">0</span>] == <span class="hljs-number">2</span>, <span class="hljs-string">f&#x27;æœŸæœ›å½¢çŠ¶ä¸º (2,E) çš„è¾¹ç´¢å¼•ï¼Œå¾—åˆ°äº† <span class="hljs-subst">&#123;edge_index.shape&#125;</span>&#x27;</span><br><br>        <span class="hljs-comment"># å½¢çŠ¶ = (N, FIN)ï¼Œå…¶ä¸­ N æ˜¯å›¾ä¸­çš„èŠ‚ç‚¹æ•°ï¼ŒFIN æ˜¯æ¯ä¸ªèŠ‚ç‚¹çš„è¾“å…¥ç‰¹å¾æ•°</span><br>        <span class="hljs-comment"># æˆ‘ä»¬å¯¹æ‰€æœ‰è¾“å…¥èŠ‚ç‚¹ç‰¹å¾åº”ç”¨ dropoutï¼ˆæ­£å¦‚è®ºæ–‡ä¸­æ‰€æåˆ°çš„ï¼‰</span><br>        <span class="hljs-comment"># æ³¨æ„ï¼šå¯¹äº Coraï¼Œç‰¹å¾å·²ç»éå¸¸ç¨€ç–ï¼Œæ‰€ä»¥å®é™…ä¸Šå¯èƒ½å¸®åŠ©ä¸å¤§</span><br>        in_nodes_features = <span class="hljs-variable language_">self</span>.dropout(in_nodes_features)<br><br>        <span class="hljs-comment"># å½¢çŠ¶ = (N, FIN) * (FIN, NH*FOUT) -&gt; (N, NH, FOUT)ï¼Œå…¶ä¸­ NH æ˜¯æ³¨æ„åŠ›å¤´çš„æ•°é‡ï¼ŒFOUT æ˜¯è¾“å‡ºç‰¹å¾çš„æ•°é‡</span><br>        <span class="hljs-comment"># æˆ‘ä»¬å°†è¾“å…¥èŠ‚ç‚¹ç‰¹å¾æŠ•å½±åˆ° NH ä¸ªç‹¬ç«‹çš„è¾“å‡ºç‰¹å¾ä¸­ï¼ˆæ¯ä¸ªæ³¨æ„åŠ›å¤´ä¸€ä¸ªï¼‰</span><br>        nodes_features_proj = <span class="hljs-variable language_">self</span>.linear_proj(in_nodes_features).view(-<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.num_of_heads, <span class="hljs-variable language_">self</span>.num_out_features)<br><br>        nodes_features_proj = <span class="hljs-variable language_">self</span>.dropout(nodes_features_proj)  <span class="hljs-comment"># åœ¨å®˜æ–¹ GAT å®ç°ä¸­ï¼Œä»–ä»¬åœ¨è¿™é‡Œä¹Ÿä½¿ç”¨äº† dropout</span><br><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># æ­¥éª¤ 2ï¼šè¾¹æ³¨æ„åŠ›è®¡ç®—</span><br>        <span class="hljs-comment">#</span><br><br>        <span class="hljs-comment"># åº”ç”¨è¯„åˆ†å‡½æ•°ï¼ˆ* è¡¨ç¤ºæŒ‰å…ƒç´ ï¼ˆä¹Ÿç§°ä¸ºHadamardï¼‰ä¹˜æ³•ï¼‰</span><br>        <span class="hljs-comment"># å½¢çŠ¶ = (N, NH, FOUT) * (1, NH, FOUT) -&gt; (N, NH, 1) -&gt; (N, NH)ï¼Œå› ä¸º sum å‹ç¼©äº†æœ€åä¸€ä¸ªç»´åº¦</span><br>        <span class="hljs-comment"># ä¼˜åŒ–æ³¨ï¼šåœ¨æˆ‘çš„å®éªŒä¸­ï¼Œtorch.sum() çš„æ€§èƒ½ä¸ .sum() ä¸€æ ·å¥½</span><br>        scores_source = (nodes_features_proj * <span class="hljs-variable language_">self</span>.scoring_fn_source).<span class="hljs-built_in">sum</span>(dim=-<span class="hljs-number">1</span>)<br>        scores_target = (nodes_features_proj * <span class="hljs-variable language_">self</span>.scoring_fn_target).<span class="hljs-built_in">sum</span>(dim=-<span class="hljs-number">1</span>)<br><br>        <span class="hljs-comment"># æˆ‘ä»¬åªéœ€æ ¹æ®è¾¹ç´¢å¼•å¤åˆ¶ï¼ˆæå‡ï¼‰æº/ç›®æ ‡èŠ‚ç‚¹çš„åˆ†æ•°ã€‚æˆ‘ä»¬ä¸éœ€è¦å‡†å¤‡æ‰€æœ‰å¯èƒ½çš„åˆ†æ•°ç»„åˆï¼Œ</span><br>        <span class="hljs-comment"># æˆ‘ä»¬åªéœ€è¦å‡†å¤‡é‚£äº›å°†å®é™…ä½¿ç”¨çš„åˆ†æ•°ç»„åˆï¼Œè¿™ç”±è¾¹ç´¢å¼•å®šä¹‰</span><br>        <span class="hljs-comment"># åˆ†æ•°å½¢çŠ¶ = (E, NH)ï¼Œnodes_features_proj_lifted å½¢çŠ¶ = (E, NH, FOUT)ï¼ŒE æ˜¯å›¾ä¸­çš„è¾¹æ•°</span><br>        scores_source_lifted, scores_target_lifted, nodes_features_proj_lifted = <span class="hljs-variable language_">self</span>.lift(scores_source, scores_target, nodes_features_proj, edge_index)<br>        scores_per_edge = <span class="hljs-variable language_">self</span>.leakyReLU(scores_source_lifted + scores_target_lifted)<br><br>        <span class="hljs-comment"># å½¢çŠ¶ = (E, NH, 1)</span><br>        attentions_per_edge = <span class="hljs-variable language_">self</span>.neighborhood_aware_softmax(scores_per_edge, edge_index[<span class="hljs-variable language_">self</span>.trg_nodes_dim], num_of_nodes)<br>        <span class="hljs-comment"># å¯¹é‚»å±…èšåˆæ·»åŠ éšæœºæ€§</span><br>        attentions_per_edge = <span class="hljs-variable language_">self</span>.dropout(attentions_per_edge)<br><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># æ­¥éª¤ 3ï¼šé‚»å±…èšåˆ</span><br>        <span class="hljs-comment">#</span><br><br>        <span class="hljs-comment"># é€å…ƒç´ ï¼ˆä¹Ÿç§°ä¸ºHadamardï¼‰ä¹˜æ³•ã€‚è¿ç®—ç¬¦ * æ‰§è¡Œä¸ torch.mul ç›¸åŒçš„æ“ä½œ</span><br>        <span class="hljs-comment"># å½¢çŠ¶ = (E, NH, FOUT) * (E, NH, 1) -&gt; (E, NH, FOUT)ï¼Œ1 è¢«å¹¿æ’­åˆ° FOUT</span><br>        nodes_features_proj_lifted_weighted = nodes_features_proj_lifted * attentions_per_edge<br><br>        <span class="hljs-comment"># è¿™ä¸€éƒ¨åˆ†å¯¹æ¯ä¸ªç›®æ ‡èŠ‚ç‚¹ç´¯ç§¯åŠ æƒå’ŒæŠ•å½±çš„é‚»å±…ç‰¹å¾å‘é‡</span><br>        <span class="hljs-comment"># å½¢çŠ¶ = (N, NH, FOUT)</span><br>        out_nodes_features = <span class="hljs-variable language_">self</span>.aggregate_neighbors(nodes_features_proj_lifted_weighted, edge_index, in_nodes_features, num_of_nodes)<br><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># æ­¥éª¤ 4ï¼šæ®‹å·®/è·³è·ƒè¿æ¥ã€è¿æ¥å’Œåå·®</span><br>        <span class="hljs-comment">#</span><br><br>        out_nodes_features = <span class="hljs-variable language_">self</span>.skip_concat_bias(attentions_per_edge, in_nodes_features, out_nodes_features)<br>        <span class="hljs-keyword">return</span> (out_nodes_features, edge_index)<br><br>    <span class="hljs-comment">#</span><br>    <span class="hljs-comment"># è¾…åŠ©å‡½æ•°ï¼ˆæ²¡æœ‰æ³¨é‡Šå‡ ä¹æ²¡æœ‰ä»£ç ï¼Œæ‰€ä»¥ä¸è¦å®³æ€•ï¼ï¼‰</span><br>    <span class="hljs-comment">#</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">neighborhood_aware_softmax</span>(<span class="hljs-params">self, scores_per_edge, trg_index, num_of_nodes</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        æ­£å¦‚å‡½æ•°åæ‰€ç¤ºï¼Œå®ƒå¯¹é‚»å±…æ‰§è¡Œ softmaxã€‚ä¾‹å¦‚ï¼šå‡è®¾å›¾ä¸­æœ‰ 5 ä¸ªèŠ‚ç‚¹ã€‚å…¶ä¸­çš„ä¸¤ä¸ªèŠ‚ç‚¹ 1ã€2 ä¸èŠ‚ç‚¹ 3 ç›¸è¿ã€‚</span><br><span class="hljs-string">        å¦‚æœæˆ‘ä»¬è¦è®¡ç®—èŠ‚ç‚¹ 3 çš„è¡¨ç¤ºï¼Œæˆ‘ä»¬åº”è¯¥è€ƒè™‘èŠ‚ç‚¹ 1ã€2 å’ŒèŠ‚ç‚¹ 3 æœ¬èº«çš„ç‰¹å¾å‘é‡ã€‚ç”±äºæˆ‘ä»¬å¯¹è¾¹ 1-3ã€2-3 å’Œ 3-3 çš„åˆ†æ•°</span><br><span class="hljs-string">        è¿›è¡Œäº†è¯„ä¼°ï¼Œè¿™ä¸ªå‡½æ•°å°†è®¡ç®—ç±»ä¼¼è¿™æ ·çš„æ³¨æ„åŠ›åˆ†æ•°ï¼š1-3 / (1-3 + 2-3 + 3-3)ï¼ˆå…¶ä¸­ 1-3 æ˜¯è¿‡è½½çš„ç¬¦å·ï¼Œå®ƒè¡¨ç¤ºè¾¹ 1-3 åŠå…¶ï¼ˆexpï¼‰åˆ†æ•°ï¼‰ï¼Œ</span><br><span class="hljs-string">        ç±»ä¼¼åœ°å¯¹äº 2-3 å’Œ 3-3ï¼Œå³å¯¹äºè¿™ä¸ªé‚»å±…ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒåŒ…å«èŠ‚ç‚¹ 4 å’Œ 5 çš„å…¶ä»–è¾¹åˆ†æ•°ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">        æ³¨æ„ï¼š</span><br><span class="hljs-string">        ä» logits ä¸­å‡å»æœ€å¤§å€¼ä¸ä¼šæ”¹å˜æœ€ç»ˆç»“æœï¼Œä½†å®ƒæé«˜äº†æ•°å€¼ç¨³å®šæ€§ï¼Œå¹¶ä¸”åœ¨å‡ ä¹æ¯ä¸ªæ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å½“å¸¸è§çš„â€œæŠ€å·§â€ã€‚</span><br><span class="hljs-string">        æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹æ­¤é“¾æ¥ï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">        https://stats.stackexchange.com/questions/338285/how-does-the-subtraction-of-the-logit-maximum-improve-learning</span><br><span class="hljs-string"></span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># è®¡ç®—åˆ†å­ã€‚ä½¿ logits &lt;= 0ï¼Œä»¥ä¾¿ e^logit &lt;= 1ï¼ˆè¿™å°†æé«˜æ•°å€¼ç¨³å®šæ€§ï¼‰</span><br>        scores_per_edge = scores_per_edge - scores_per_edge.<span class="hljs-built_in">max</span>()<br>        exp_scores_per_edge = scores_per_edge.exp()  <span class="hljs-comment"># softmax</span><br><br>        <span class="hljs-comment"># è®¡ç®—åˆ†æ¯ã€‚å½¢çŠ¶ = (E, NH)</span><br>        neigborhood_aware_denominator = <span class="hljs-variable language_">self</span>.sum_edge_scores_neighborhood_aware(exp_scores_per_edge, trg_index, num_of_nodes)<br><br>        <span class="hljs-comment"># 1e-16 åœ¨ç†è®ºä¸Šä¸æ˜¯å¿…éœ€çš„ï¼Œä½†å®ƒä»…å‡ºäºæ•°å€¼ç¨³å®šæ€§è€ƒè™‘å­˜åœ¨ï¼ˆé¿å…é™¤ä»¥ 0ï¼‰- ç”±äºè®¡ç®—æœºå°†éå¸¸å°çš„æ•°å­—å››èˆäº”å…¥åˆ° 0ï¼Œè¿™æ˜¯å¯èƒ½çš„</span><br>        attentions_per_edge = exp_scores_per_edge / (neigborhood_aware_denominator + <span class="hljs-number">1e-16</span>)<br><br>        <span class="hljs-comment"># shape = (E, NH) -&gt; (E, NH, 1) so that we can do element-wise multiplication with projected node features</span><br>        <span class="hljs-keyword">return</span> attentions_per_edge.unsqueeze(-<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">sum_edge_scores_neighborhood_aware</span>(<span class="hljs-params">self, exp_scores_per_edge, trg_index, num_of_nodes</span>):<br>        <span class="hljs-comment"># å½¢çŠ¶å¿…é¡»ä¸ exp_scores_per_edge ç›¸åŒï¼ˆç”± scatter_add_ è¦æ±‚ï¼‰ï¼Œå³ä» E å˜ä¸º (E, NH)</span><br>        trg_index_broadcasted = <span class="hljs-variable language_">self</span>.explicit_broadcast(trg_index, exp_scores_per_edge)<br><br>        <span class="hljs-comment"># å½¢çŠ¶ä¸º (N, NH)ï¼Œå…¶ä¸­ N æ˜¯èŠ‚ç‚¹æ•°é‡ï¼ŒNH æ˜¯æ³¨æ„åŠ›å¤´çš„æ•°é‡</span><br>        size = <span class="hljs-built_in">list</span>(exp_scores_per_edge.shape)  <span class="hljs-comment"># è½¬æ¢ä¸ºåˆ—è¡¨ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œèµ‹å€¼</span><br>        size[<span class="hljs-variable language_">self</span>.nodes_dim] = num_of_nodes<br>        neighborhood_sums = torch.zeros(size, dtype=exp_scores_per_edge.dtype, device=exp_scores_per_edge.device)<br><br>        <span class="hljs-comment"># ä½ç½® i åŒ…å«æ‰€æœ‰æŒ‡å‘èŠ‚ç‚¹ i çš„èŠ‚ç‚¹çš„ exp åˆ†æ•°ä¹‹å’Œï¼ˆç”±ç›®æ ‡ç´¢å¼•æŒ‡å®šï¼‰</span><br>        neighborhood_sums.scatter_add_(<span class="hljs-variable language_">self</span>.nodes_dim, trg_index_broadcasted, exp_scores_per_edge)<br><br>        <span class="hljs-comment"># å†æ¬¡æ‰©å±•ï¼Œä»¥ä¾¿å°†å…¶ç”¨ä½œ softmax åˆ†æ¯ã€‚ä¾‹å¦‚ï¼ŒèŠ‚ç‚¹ i çš„æ€»å’Œå°†å¤åˆ¶åˆ°æºèŠ‚ç‚¹æŒ‡å‘ i çš„æ‰€æœ‰ä½ç½®ï¼ˆç”±ç›®æ ‡ç´¢å¼•æŒ‡å®šï¼‰</span><br>        <span class="hljs-comment"># å½¢çŠ¶ä¸º (N, NH) -&gt; (E, NH)</span><br>        <span class="hljs-keyword">return</span> neighborhood_sums.index_select(<span class="hljs-variable language_">self</span>.nodes_dim, trg_index)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">aggregate_neighbors</span>(<span class="hljs-params">self, nodes_features_proj_lifted_weighted, edge_index, in_nodes_features, num_of_nodes</span>):<br>        size = <span class="hljs-built_in">list</span>(nodes_features_proj_lifted_weighted.shape)  <span class="hljs-comment"># è½¬æ¢ä¸ºåˆ—è¡¨ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œèµ‹å€¼</span><br>        size[<span class="hljs-variable language_">self</span>.nodes_dim] = num_of_nodes  <span class="hljs-comment"># å½¢çŠ¶ä¸º (N, NH, FOUT)</span><br>        out_nodes_features = torch.zeros(size, dtype=in_nodes_features.dtype, device=in_nodes_features.device)<br><br>        <span class="hljs-comment"># å½¢çŠ¶ä¸º (E) -&gt; (E, NH, FOUT)</span><br>        trg_index_broadcasted = <span class="hljs-variable language_">self</span>.explicit_broadcast(edge_index[<span class="hljs-variable language_">self</span>.trg_nodes_dim], nodes_features_proj_lifted_weighted)<br>        <span class="hljs-comment"># èšåˆæ­¥éª¤ - æˆ‘ä»¬ç´¯ç§¯æ‰€æœ‰æ³¨æ„åŠ›å¤´çš„æŠ•å½±åŠ æƒèŠ‚ç‚¹ç‰¹å¾</span><br>        <span class="hljs-comment"># å½¢çŠ¶ä¸º (E, NH, FOUT) -&gt; (N, NH, FOUT)</span><br>        out_nodes_features.scatter_add_(<span class="hljs-variable language_">self</span>.nodes_dim, trg_index_broadcasted, nodes_features_proj_lifted_weighted)<br><br>        <span class="hljs-keyword">return</span> out_nodes_features<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lift</span>(<span class="hljs-params">self, scores_source, scores_target, nodes_features_matrix_proj, edge_index</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        æŠ¬å‡ï¼ˆLiftï¼‰å³æ ¹æ®è¾¹ç´¢å¼•å¤åˆ¶ç‰¹å®šå‘é‡ã€‚</span><br><span class="hljs-string">        å¼ é‡çš„ç»´åº¦ä¹‹ä¸€ä» N å˜ä¸º Eï¼ˆè¿™å°±æ˜¯â€œæŠ¬å‡â€ä¸€è¯çš„æ¥æºï¼‰ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        src_nodes_index = edge_index[<span class="hljs-variable language_">self</span>.src_nodes_dim]<br>        trg_nodes_index = edge_index[<span class="hljs-variable language_">self</span>.trg_nodes_dim]<br><br>        <span class="hljs-comment"># ä½¿ç”¨ index_select æ¯”åœ¨ PyTorch ä¸­ä½¿ç”¨ &quot;normal&quot; ç´¢å¼•ï¼ˆscores_source[src_nodes_index]ï¼‰æ›´å¿«ï¼</span><br>        scores_source = scores_source.index_select(<span class="hljs-variable language_">self</span>.nodes_dim, src_nodes_index)<br>        scores_target = scores_target.index_select(<span class="hljs-variable language_">self</span>.nodes_dim, trg_nodes_index)<br>        nodes_features_matrix_proj_lifted = nodes_features_matrix_proj.index_select(<span class="hljs-variable language_">self</span>.nodes_dim, src_nodes_index)<br><br>        <span class="hljs-keyword">return</span> scores_source, scores_target, nodes_features_matrix_proj_lifted<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">explicit_broadcast</span>(<span class="hljs-params">self, this, other</span>):<br>        <span class="hljs-comment"># é™„åŠ å•ä¾‹ç»´åº¦ï¼Œç›´åˆ° this.dim() == other.dim()</span><br>        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(this.dim(), other.dim()):<br>            this = this.unsqueeze(-<span class="hljs-number">1</span>)<br><br>        <span class="hljs-comment"># æ˜ç¡®æ‰©å±•ä»¥ä½¿å½¢çŠ¶ç›¸åŒ</span><br>        <span class="hljs-keyword">return</span> this.expand_as(other)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">init_params</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        æˆ‘ä»¬ä½¿ç”¨ Glorotï¼ˆä¹Ÿç§°ä¸º Xavier å‡åŒ€ï¼‰åˆå§‹åŒ–çš„åŸå› æ˜¯å› ä¸ºå®ƒæ˜¯ TF çš„é»˜è®¤åˆå§‹åŒ–æ–¹å¼ï¼š</span><br><span class="hljs-string">            https://stackoverflow.com/questions/37350131/what-is-the-default-variable-initializer-in-tensorflow</span><br><span class="hljs-string"></span><br><span class="hljs-string">        åŸå§‹åº“åœ¨ TensorFlowï¼ˆTFï¼‰ä¸­å¼€å‘ï¼Œå¹¶ä¸”ä»–ä»¬ä½¿ç”¨äº†é»˜è®¤åˆå§‹åŒ–ã€‚</span><br><span class="hljs-string">        éšæ—¶è¿›è¡Œå®éªŒ - æ ¹æ®é—®é¢˜å¯èƒ½æœ‰æ›´å¥½çš„åˆå§‹åŒ–æ–¹æ³•ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        nn.init.xavier_uniform_(<span class="hljs-variable language_">self</span>.linear_proj.weight)<br>        nn.init.xavier_uniform_(<span class="hljs-variable language_">self</span>.scoring_fn_target)<br>        nn.init.xavier_uniform_(<span class="hljs-variable language_">self</span>.scoring_fn_source)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.bias <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            torch.nn.init.zeros_(<span class="hljs-variable language_">self</span>.bias)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">skip_concat_bias</span>(<span class="hljs-params">self, attention_coefficients, in_nodes_features, out_nodes_features</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.log_attention_weights:  <span class="hljs-comment"># å¯èƒ½è®°å½•ä»¥ä¾›ç¨ååœ¨ playground.py ä¸­å¯è§†åŒ–</span><br>            <span class="hljs-variable language_">self</span>.attention_weights = attention_coefficients<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.add_skip_connection:  <span class="hljs-comment"># æ·»åŠ è·³è·ƒæˆ–æ®‹å·®è¿æ¥</span><br>            <span class="hljs-keyword">if</span> out_nodes_features.shape[-<span class="hljs-number">1</span>] == in_nodes_features.shape[-<span class="hljs-number">1</span>]:  <span class="hljs-comment"># å¦‚æœ FIN == FOUT</span><br>                <span class="hljs-comment"># unsqueeze å®ç°ä»¥ä¸‹æ•ˆæœï¼š(N, FIN) -&gt; (N, 1, FIN)ï¼Œè¾“å‡ºç‰¹å¾ä¸º (N, NH, FOUT) æ‰€ä»¥ 1 è¢«å¹¿æ’­åˆ° NH</span><br>                <span class="hljs-comment"># å› æ­¤ï¼ŒåŸºæœ¬ä¸Šæˆ‘ä»¬å°†è¾“å…¥å‘é‡ NH æ¬¡å¤åˆ¶å¹¶æ·»åŠ åˆ°å¤„ç†è¿‡çš„å‘é‡ä¸­</span><br>                out_nodes_features += in_nodes_features.unsqueeze(<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># FIN != FOUTï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†è¾“å…¥ç‰¹å¾å‘é‡æŠ•å½±åˆ°å¯ä»¥æ·»åŠ åˆ°è¾“å‡ºç‰¹å¾å‘é‡çš„ç»´åº¦ã€‚</span><br>                <span class="hljs-comment"># skip_proj æ·»åŠ äº†å¤§é‡é¢å¤–çš„å®¹é‡ï¼Œè¿™å¯èƒ½å¯¼è‡´è¿‡æ‹Ÿåˆã€‚</span><br>                out_nodes_features += <span class="hljs-variable language_">self</span>.skip_proj(in_nodes_features).view(-<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.num_of_heads, <span class="hljs-variable language_">self</span>.num_out_features)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.concat:<br>            <span class="hljs-comment"># å½¢çŠ¶ä¸º (N, NH, FOUT) -&gt; (N, NH*FOUT)</span><br>            out_nodes_features = out_nodes_features.view(-<span class="hljs-number">1</span>, <span class="hljs-variable language_">self</span>.num_of_heads * <span class="hljs-variable language_">self</span>.num_out_features)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># å½¢çŠ¶ä¸º (N, NH, FOUT) -&gt; (N, FOUT)</span><br>            out_nodes_features = out_nodes_features.mean(dim=<span class="hljs-variable language_">self</span>.head_dim)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.bias <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            out_nodes_features += <span class="hljs-variable language_">self</span>.bias<br><br>        <span class="hljs-keyword">return</span> out_nodes_features <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.activation <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> <span class="hljs-variable language_">self</span>.activation(out_nodes_features)<br></code></pre></td></tr></table></figure>

<p>å·¨å¤§èŠ‚çœçš„æ€æƒ³æ˜¯ä»…è®¡ç®—å®é™…ä½¿ç”¨çš„èŠ‚ç‚¹çš„åˆ†æ•°ï¼Œè€Œä¸æ˜¯è®¡ç®—æ¯ä¸ªå¯æƒ³è±¡çš„ç»„åˆçš„åˆ†æ•°ï¼ˆè¿™ä»…åœ¨å®Œå…¨è¿æ¥çš„å›¾ä¸­æœ‰æ•ˆï¼‰ã€‚</p>
<p>ä¸€æ—¦æˆ‘ä»¬è®¡ç®—å‡ºâ€leftâ€åˆ†æ•°å’Œâ€rightâ€åˆ†æ•°ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨è¾¹ç´¢å¼•â€œliftâ€å®ƒä»¬ã€‚è¿™æ ·ï¼Œå¦‚æœ1-&gt;2å›¾ä¸­ä¸å­˜åœ¨è¾¹ï¼Œæˆ‘ä»¬çš„æ•°æ®ç»“æ„ä¸­å°±ä¸ä¼šæœ‰è¿™äº›åˆ†æ•°å¯¹ã€‚</p>
<p>åœ¨æ·»åŠ æå‡çš„â€œå·¦â€å’Œâ€œå³â€ï¼ˆæˆ–è€…æ›´å¥½çš„å‘½åæ–¹å¼æ˜¯æºå’Œç›®æ ‡ï¼‰åˆ†æ•°åï¼Œæˆ‘ä»¬å¾ˆèªæ˜çš„ç”¨neighborhood-aware softmax-è¿™æ · GATçš„è¯­ä¹‰å°±å¾—åˆ°äº†è¡¨è¾¾ã€‚å®Œæˆåscatter addï¼ˆæ‚¨åº”è¯¥èŠ±æ—¶é—´ç†è§£å¹¶é˜…è¯»æ–‡æ¡£ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç»„åˆæŠ•å½±çš„ç‰¹å¾å‘é‡ï¼Œç§ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæˆç†Ÿçš„ GAT å±‚ã€‚</p>
<hr>
<p>æ…¢æ…¢æ¥ï¼Œè¦æœ‰è€å¿ƒï¼ç‰¹åˆ«æ˜¯å¦‚æœæ‚¨æ˜¯ GNN æ–°æ‰‹ã€‚</p>
<p>æˆ‘ä¸æ˜¯ä¸€å¤©å°±èƒ½å­¦ä¼šæ‰€æœ‰è¿™äº›çš„ï¼Œéœ€è¦æ—¶é—´æ¥æ¶ˆåŒ–çŸ¥è¯†ã€‚</p>
<p>è¯è™½å¦‚æ­¤ï¼Œæˆ‘ä»¬å·²ç»è§£é”äº†ç¬¬ 3 çº§ï¼ˆæ¨¡å‹è®­ç»ƒ ğŸ’ªï¼‰ã€‚ğŸ˜<br>æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†æ•°æ®ğŸ“œï¼Œæˆ‘ä»¬å·²ç»å‡†å¤‡å¥½äº†GATæ¨¡å‹ğŸ¦„ï¼Œè®©æˆ‘ä»¬å¼€å§‹è®­ç»ƒè¿™å¤´é‡å…½å§ï¼ğŸ’ª</p>
<h1 id="ç¬¬-3-éƒ¨åˆ†ï¼šè®­ç»ƒ-GAT-ğŸ’ªï¼ˆCora-ä¸Šçš„åˆ†ç±»ï¼ï¼‰"><a href="#ç¬¬-3-éƒ¨åˆ†ï¼šè®­ç»ƒ-GAT-ğŸ’ªï¼ˆCora-ä¸Šçš„åˆ†ç±»ï¼ï¼‰" class="headerlink" title="ç¬¬ 3 éƒ¨åˆ†ï¼šè®­ç»ƒ GAT ğŸ’ªï¼ˆCora ä¸Šçš„åˆ†ç±»ï¼ï¼‰"></a>ç¬¬ 3 éƒ¨åˆ†ï¼šè®­ç»ƒ GAT ğŸ’ªï¼ˆCora ä¸Šçš„åˆ†ç±»ï¼ï¼‰</h1><p>å”·ï¼Œå¥½å§ï¼Œæœ€å›°éš¾çš„éƒ¨åˆ†å·²ç»è¿‡å»äº†ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„è®­ç»ƒå¾ªç¯ï¼Œå…¶ç›®æ ‡æ˜¯å­¦ä¹ å¯¹ Cora èŠ‚ç‚¹è¿›è¡Œåˆ†ç±»ã€‚</p>
<p>ä½†é¦–å…ˆè®©æˆ‘ä»¬å®šä¹‰ä¸€äº›ç›¸å…³çš„å¸¸é‡ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.tensorboard <span class="hljs-keyword">import</span> SummaryWriter<br><br><span class="hljs-comment"># train.py ä¸­ä½¿ç”¨çš„ 3 ä¸ªä¸åŒçš„æ¨¡å‹è®­ç»ƒ/è¯„ä¼°é˜¶æ®µ</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoopPhase</span>(enum.Enum):<br>    TRAIN = <span class="hljs-number">0</span>,  <span class="hljs-comment"># è®­ç»ƒé˜¶æ®µ</span><br>    VAL = <span class="hljs-number">1</span>,    <span class="hljs-comment"># éªŒè¯é˜¶æ®µ</span><br>    TEST = <span class="hljs-number">2</span>    <span class="hljs-comment"># æµ‹è¯•é˜¶æ®µ</span><br><br>writer = SummaryWriter()  <span class="hljs-comment"># ï¼ˆtensorboardï¼‰writer é»˜è®¤å°†è¾“å‡ºåˆ° ./runs/ ç›®å½•</span><br><br><span class="hljs-comment"># ç”¨äºæå‰åœæ­¢çš„å…¨å±€å˜é‡ã€‚åœ¨æ²¡æœ‰åœ¨éªŒè¯æ•°æ®é›†ä¸Šæœ‰ä»»ä½•æ”¹è¿›ï¼ˆé€šè¿‡å‡†ç¡®æ€§åº¦é‡ï¼‰çš„æƒ…å†µä¸‹ï¼Œ</span><br><span class="hljs-comment"># ç»è¿‡ä¸€å®šæ•°é‡çš„ epochsï¼ˆç”± patience_period å˜é‡å®šä¹‰ï¼‰ï¼Œæˆ‘ä»¬å°†é€€å‡ºè®­ç»ƒå¾ªç¯ã€‚</span><br>BEST_VAL_ACC = <span class="hljs-number">0</span>      <span class="hljs-comment"># æœ€ä½³éªŒè¯å‡†ç¡®æ€§</span><br>BEST_VAL_LOSS = <span class="hljs-number">0</span>     <span class="hljs-comment"># æœ€ä½³éªŒè¯æŸå¤±</span><br>PATIENCE_CNT = <span class="hljs-number">0</span>      <span class="hljs-comment"># å¿è€è®¡æ•°</span><br><br>BINARIES_PATH = os.path.join(os.getcwd(), <span class="hljs-string">&#x27;models&#x27;</span>, <span class="hljs-string">&#x27;binaries&#x27;</span>)  <span class="hljs-comment"># å­˜å‚¨äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„</span><br>CHECKPOINTS_PATH = os.path.join(os.getcwd(), <span class="hljs-string">&#x27;models&#x27;</span>, <span class="hljs-string">&#x27;checkpoints&#x27;</span>)  <span class="hljs-comment"># å­˜å‚¨æ£€æŸ¥ç‚¹çš„è·¯å¾„</span><br><br><span class="hljs-comment"># ç¡®ä¿è¿™äº›è·¯å¾„å­˜åœ¨ï¼Œå› ä¸ºä»£ç çš„å…¶ä½™éƒ¨åˆ†å‡å®šå­˜åœ¨å®ƒä»¬</span><br>os.makedirs(BINARIES_PATH, exist_ok=<span class="hljs-literal">True</span>)<br>os.makedirs(CHECKPOINTS_PATH, exist_ok=<span class="hljs-literal">True</span>)<br><br></code></pre></td></tr></table></figure>

<p>å¦å¤–ï¼Œæˆ‘ä»¬å®šä¹‰å‡ ä¸ªåœ¨è®­ç»ƒæ¨¡å‹æ—¶æœ‰ç”¨çš„å‡½æ•°ã€‚</p>
<p>è®­ç»ƒçŠ¶æ€åŒ…å«å¾ˆå¤šæœ‰ç”¨çš„å†…å®¹metadataï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»¥åä½¿ç”¨ã€‚æ‚¨å¯ä»¥æƒ³è±¡ï¼Œä¿å­˜æ¨¡å‹çš„æµ‹è¯•å‡†ç¡®æ€§éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯å½“æ‚¨åœ¨äº‘ä¸Šè®­ç»ƒæ¨¡å‹æ—¶ - å®ƒä½¿ç»„ç»‡å˜å¾—æ›´å¥½ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> git<br><span class="hljs-keyword">import</span> re  <span class="hljs-comment"># æ­£åˆ™è¡¨è¾¾å¼</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_training_state</span>(<span class="hljs-params">training_config, model</span>):<br>    training_state = &#123;<br>        <span class="hljs-string">&quot;commit_hash&quot;</span>: git.Repo(search_parent_directories=<span class="hljs-literal">True</span>).head.<span class="hljs-built_in">object</span>.hexsha,<br><br>        <span class="hljs-comment"># è®­ç»ƒè¯¦ç»†ä¿¡æ¯</span><br>        <span class="hljs-string">&quot;dataset_name&quot;</span>: training_config[<span class="hljs-string">&#x27;dataset_name&#x27;</span>],  <span class="hljs-comment"># æ•°æ®é›†åç§°</span><br>        <span class="hljs-string">&quot;num_of_epochs&quot;</span>: training_config[<span class="hljs-string">&#x27;num_of_epochs&#x27;</span>],  <span class="hljs-comment"># è®­ç»ƒçš„ epochs æ•°é‡</span><br>        <span class="hljs-string">&quot;test_acc&quot;</span>: training_config[<span class="hljs-string">&#x27;test_acc&#x27;</span>],  <span class="hljs-comment"># æµ‹è¯•å‡†ç¡®åº¦</span><br><br>        <span class="hljs-comment"># æ¨¡å‹ç»“æ„</span><br>        <span class="hljs-string">&quot;num_of_layers&quot;</span>: training_config[<span class="hljs-string">&#x27;num_of_layers&#x27;</span>],  <span class="hljs-comment"># å±‚çš„æ•°é‡</span><br>        <span class="hljs-string">&quot;num_heads_per_layer&quot;</span>: training_config[<span class="hljs-string">&#x27;num_heads_per_layer&#x27;</span>],  <span class="hljs-comment"># æ¯å±‚çš„æ³¨æ„åŠ›å¤´æ•°</span><br>        <span class="hljs-string">&quot;num_features_per_layer&quot;</span>: training_config[<span class="hljs-string">&#x27;num_features_per_layer&#x27;</span>],  <span class="hljs-comment"># æ¯å±‚çš„ç‰¹å¾æ•°</span><br>        <span class="hljs-string">&quot;add_skip_connection&quot;</span>: training_config[<span class="hljs-string">&#x27;add_skip_connection&#x27;</span>],  <span class="hljs-comment"># æ˜¯å¦æ·»åŠ è·³è·ƒè¿æ¥</span><br>        <span class="hljs-string">&quot;bias&quot;</span>: training_config[<span class="hljs-string">&#x27;bias&#x27;</span>],  <span class="hljs-comment"># æ˜¯å¦ä½¿ç”¨åç½®</span><br>        <span class="hljs-string">&quot;dropout&quot;</span>: training_config[<span class="hljs-string">&#x27;dropout&#x27;</span>],  <span class="hljs-comment"># ä¸¢å¼ƒç‡</span><br><br>        <span class="hljs-comment"># æ¨¡å‹çŠ¶æ€</span><br>        <span class="hljs-string">&quot;state_dict&quot;</span>: model.state_dict()  <span class="hljs-comment"># æ¨¡å‹çš„çŠ¶æ€å­—å…¸</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> training_state<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">print_model_metadata</span>(<span class="hljs-params">training_state</span>):<br>    header = <span class="hljs-string">f&#x27;\n<span class="hljs-subst">&#123;<span class="hljs-string">&quot;*&quot;</span>*<span class="hljs-number">5</span>&#125;</span> æ¨¡å‹è®­ç»ƒå…ƒæ•°æ®: <span class="hljs-subst">&#123;<span class="hljs-string">&quot;*&quot;</span>*<span class="hljs-number">5</span>&#125;</span>&#x27;</span><br>    <span class="hljs-built_in">print</span>(header)<br><br>    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> training_state.items():<br>        <span class="hljs-keyword">if</span> key != <span class="hljs-string">&#x27;state_dict&#x27;</span>:  <span class="hljs-comment"># ä¸æ‰“å° state_dictï¼Œå› ä¸ºå®ƒåªæ˜¯ä¸€å †æ•°å­—...</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;key&#125;</span>: <span class="hljs-subst">&#123;value&#125;</span>&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;<span class="hljs-string">&quot;*&quot;</span> * <span class="hljs-built_in">len</span>(header)&#125;</span>\n&#x27;</span>)<br><br><br><span class="hljs-comment"># ç¡®ä¿æˆ‘ä»¬ä¸è¦†ç›–æœ‰ä»·å€¼çš„æ¨¡å‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¯ä»¥å¿½ç•¥ - å¯¹ GAT æ–¹æ³•ä¸æ˜¯å…³é”®çš„ï¼‰</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_available_binary_name</span>():<br>    prefix = <span class="hljs-string">&#x27;gat&#x27;</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">valid_binary_name</span>(<span class="hljs-params">binary_name</span>):<br>        <span class="hljs-comment"># ç¬¬ä¸€æ¬¡çœ‹åˆ°åŸå§‹ f-å­—ç¬¦ä¸²ï¼Ÿä¸ç”¨æ‹…å¿ƒï¼Œå”¯ä¸€çš„æŠ€å·§æ˜¯è¦åŠ å€å¤§æ‹¬å·ã€‚</span><br>        pattern = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">rf&#x27;<span class="hljs-subst">&#123;prefix&#125;</span>_[0-9]&#123;&#123;6&#125;&#125;\.pth&#x27;</span>)<br>        <span class="hljs-keyword">return</span> re.fullmatch(pattern, binary_name) <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># åªéœ€åˆ—å‡ºç°æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»¥ä¾¿æˆ‘ä»¬ä¸ä¼šè¦†ç›–å®ƒä»¬ï¼Œè€Œæ˜¯å†™å…¥æ–°çš„äºŒè¿›åˆ¶æ–‡ä»¶</span><br>    valid_binary_names = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(valid_binary_name, os.listdir(BINARIES_PATH)))<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(valid_binary_names) &gt; <span class="hljs-number">0</span>:<br>        last_binary_name = <span class="hljs-built_in">sorted</span>(valid_binary_names)[-<span class="hljs-number">1</span>]<br>        new_suffix = <span class="hljs-built_in">int</span>(last_binary_name.split(<span class="hljs-string">&#x27;.&#x27;</span>)[<span class="hljs-number">0</span>][-<span class="hljs-number">6</span>:]) + <span class="hljs-number">1</span>  <span class="hljs-comment"># é€’å¢ 1</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;prefix&#125;</span>_<span class="hljs-subst">&#123;<span class="hljs-built_in">str</span>(new_suffix).zfill(<span class="hljs-number">6</span>)&#125;</span>.pth&#x27;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;prefix&#125;</span>_000000.pth&#x27;</span><br><br></code></pre></td></tr></table></figure>

<p>å¾ˆå¥½ï¼Œç°åœ¨æ˜¯ç»„ç»‡ç¨‹åºè®¾ç½®çš„argparseå¥½æ–¹æ³•ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> argparse<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_training_args</span>():<br>    parser = argparse.ArgumentParser()<br><br>    <span class="hljs-comment"># ä¸è®­ç»ƒç›¸å…³</span><br>    parser.add_argument(<span class="hljs-string">&quot;--num_of_epochs&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;è®­ç»ƒè½®æ•°&quot;</span>, default=<span class="hljs-number">10000</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--patience_period&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;åœ¨ç»ˆæ­¢ä¹‹å‰åœ¨éªŒè¯é›†ä¸Šæ²¡æœ‰æ”¹è¿›çš„è½®æ•°&quot;</span>, default=<span class="hljs-number">1000</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--lr&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">float</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;æ¨¡å‹å­¦ä¹ ç‡&quot;</span>, default=<span class="hljs-number">5e-3</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--weight_decay&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">float</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;æ¨¡å‹æƒé‡çš„L2æ­£åˆ™åŒ–&quot;</span>, default=<span class="hljs-number">5e-4</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--should_test&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;æ˜¯å¦åœ¨æµ‹è¯•é›†ä¸Šæµ‹è¯•æ¨¡å‹ï¼Ÿ&#x27;</span>, default=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-comment"># æ•°æ®é›†ç›¸å…³</span><br>    parser.add_argument(<span class="hljs-string">&quot;--dataset_name&quot;</span>, choices=[el.name <span class="hljs-keyword">for</span> el <span class="hljs-keyword">in</span> DatasetType], <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;ç”¨äºè®­ç»ƒçš„æ•°æ®é›†&#x27;</span>, default=DatasetType.CORA.name)<br>    parser.add_argument(<span class="hljs-string">&quot;--should_visualize&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&#x27;æ˜¯å¦å¯è§†åŒ–æ•°æ®é›†ï¼Ÿ&#x27;</span>, default=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-comment"># æ—¥å¿—/è°ƒè¯•/æ£€æŸ¥ç‚¹ç›¸å…³ï¼ˆå¯¹å®éªŒéå¸¸æœ‰å¸®åŠ©ï¼‰</span><br>    parser.add_argument(<span class="hljs-string">&quot;--enable_tensorboard&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;å¯ç”¨TensorBoardæ—¥å¿—&quot;</span>, default=<span class="hljs-literal">False</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--console_log_freq&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;è¾“å‡ºåˆ°æ§åˆ¶å°çš„æ—¥å¿—ï¼ˆæ¯è½®ï¼‰é¢‘ç‡ï¼ˆæ— æ—¥å¿—åˆ™ä¸ºNoneï¼‰&quot;</span>, default=<span class="hljs-number">100</span>)<br>    parser.add_argument(<span class="hljs-string">&quot;--checkpoint_freq&quot;</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">&quot;æ£€æŸ¥ç‚¹æ¨¡å‹ä¿å­˜ï¼ˆæ¯è½®ï¼‰é¢‘ç‡ï¼ˆæ— æ—¥å¿—åˆ™ä¸ºNoneï¼‰&quot;</span>, default=<span class="hljs-number">1000</span>)<br>    args = parser.parse_args(<span class="hljs-string">&quot;&quot;</span>)<br><br>    <span class="hljs-comment"># æ¨¡å‹æ¶æ„ç›¸å…³ - è¿™æ˜¯åœ¨å®˜æ–¹è®ºæ–‡ä¸­å®šä¹‰çš„ç”¨äºCoraåˆ†ç±»çš„æ¶æ„</span><br>    gat_config = &#123;<br>        <span class="hljs-string">&quot;num_of_layers&quot;</span>: <span class="hljs-number">2</span>,  <span class="hljs-comment"># GNNsä¸CNNsç›¸åï¼Œé€šå¸¸æ˜¯æµ…å±‚çš„ï¼ˆæœ€ç»ˆå–å†³äºå›¾çš„å±æ€§ï¼‰</span><br>        <span class="hljs-string">&quot;num_heads_per_layer&quot;</span>: [<span class="hljs-number">8</span>, <span class="hljs-number">1</span>],<br>        <span class="hljs-string">&quot;num_features_per_layer&quot;</span>: [CORA_NUM_INPUT_FEATURES, <span class="hljs-number">8</span>, CORA_NUM_CLASSES],<br>        <span class="hljs-string">&quot;add_skip_connection&quot;</span>: <span class="hljs-literal">False</span>,  <span class="hljs-comment"># åœ¨Coraä¸Šå½±å“æ€§èƒ½</span><br>        <span class="hljs-string">&quot;bias&quot;</span>: <span class="hljs-literal">True</span>,  <span class="hljs-comment"># ç»“æœå¯¹åç½®ä¸å¤ªæ•æ„Ÿ</span><br>        <span class="hljs-string">&quot;dropout&quot;</span>: <span class="hljs-number">0.6</span>,  <span class="hljs-comment"># å¯¹ä¸¢å¤±çµæ•</span><br>    &#125;<br><br>    <span class="hljs-comment"># å°†è®­ç»ƒé…ç½®å°è£…åˆ°å­—å…¸ä¸­</span><br>    training_config = <span class="hljs-built_in">dict</span>()<br>    <span class="hljs-keyword">for</span> arg <span class="hljs-keyword">in</span> <span class="hljs-built_in">vars</span>(args):<br>        training_config[arg] = <span class="hljs-built_in">getattr</span>(args, arg)<br><br>    <span class="hljs-comment"># æ·»åŠ é™„åŠ çš„é…ç½®ä¿¡æ¯</span><br>    training_config.update(gat_config)<br><br>    <span class="hljs-keyword">return</span> training_config<br><br></code></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç»„ç»‡äº†é«˜çº§åˆ«çš„ GAT è®­ç»ƒæ‰€éœ€çš„ä¸€åˆ‡ã€‚åªéœ€ç»“åˆæˆ‘ä»¬å·²ç»å­¦è¿‡çš„éƒ¨åˆ†å³å¯ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_gat</span>(<span class="hljs-params">config</span>):<br>    <span class="hljs-keyword">global</span> BEST_VAL_ACC, BEST_VAL_LOSS<br><br>    device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)  <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦æœ‰GPUï¼Œå¸Œæœ›æœ‰ï¼</span><br><br>    <span class="hljs-comment"># æ­¥éª¤1ï¼šåŠ è½½å›¾æ•°æ®</span><br>    node_features, node_labels, edge_index, train_indices, val_indices, test_indices = load_graph_data(config, device)<br><br>    <span class="hljs-comment"># æ­¥éª¤2ï¼šå‡†å¤‡æ¨¡å‹</span><br>    gat = GAT(<br>        num_of_layers=config[<span class="hljs-string">&#x27;num_of_layers&#x27;</span>],<br>        num_heads_per_layer=config[<span class="hljs-string">&#x27;num_heads_per_layer&#x27;</span>],<br>        num_features_per_layer=config[<span class="hljs-string">&#x27;num_features_per_layer&#x27;</span>],<br>        add_skip_connection=config[<span class="hljs-string">&#x27;add_skip_connection&#x27;</span>],<br>        bias=config[<span class="hljs-string">&#x27;bias&#x27;</span>],<br>        dropout=config[<span class="hljs-string">&#x27;dropout&#x27;</span>],<br>        log_attention_weights=<span class="hljs-literal">False</span>  <span class="hljs-comment"># ä¸éœ€è¦å­˜å‚¨æ³¨æ„åŠ›ï¼Œä»…åœ¨ playground.py ä¸­ç”¨äºå¯è§†åŒ–</span><br>    ).to(device)<br><br>    <span class="hljs-comment"># æ­¥éª¤3ï¼šå‡†å¤‡å…¶ä»–ä¸è®­ç»ƒç›¸å…³çš„å·¥å…·ï¼ˆæŸå¤±å’Œä¼˜åŒ–å™¨ä»¥åŠè£…é¥°å‡½æ•°ï¼‰</span><br>    loss_fn = nn.CrossEntropyLoss(reduction=<span class="hljs-string">&#x27;mean&#x27;</span>)<br>    optimizer = Adam(gat.parameters(), lr=config[<span class="hljs-string">&#x27;lr&#x27;</span>], weight_decay=config[<span class="hljs-string">&#x27;weight_decay&#x27;</span>])<br><br>    <span class="hljs-comment"># è¿™æ˜¯è®­ç»ƒçš„æ ¸å¿ƒéƒ¨åˆ†ï¼ˆæˆ‘ä»¬ç¨åä¼šå®šä¹‰å®ƒï¼‰</span><br>    <span class="hljs-comment"># è£…é¥°å‡½æ•°ä½¿å¾—ä»£ç æ›´æ•´æ´ï¼Œå› ä¸ºåœ¨è®­ç»ƒå’ŒéªŒè¯å¾ªç¯ä¹‹é—´æœ‰å¾ˆå¤šå†—ä½™</span><br>    main_loop = get_main_loop(<br>        config,<br>        gat,<br>        loss_fn,<br>        optimizer,<br>        node_features,<br>        node_labels,<br>        edge_index,<br>        train_indices,<br>        val_indices,<br>        test_indices,<br>        config[<span class="hljs-string">&#x27;patience_period&#x27;</span>],<br>        time.time())<br><br>    BEST_VAL_ACC, BEST_VAL_LOSS, PATIENCE_CNT = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># é‡ç½®ç”¨äºæå‰åœæ­¢çš„å˜é‡</span><br><br>    <span class="hljs-comment"># æ­¥éª¤4ï¼šå¼€å§‹è®­ç»ƒè¿‡ç¨‹</span><br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(config[<span class="hljs-string">&#x27;num_of_epochs&#x27;</span>]):<br>        <span class="hljs-comment"># è®­ç»ƒå¾ªç¯</span><br>        main_loop(phase=LoopPhase.TRAIN, epoch=epoch)<br><br>        <span class="hljs-comment"># éªŒè¯å¾ªç¯</span><br>        <span class="hljs-keyword">with</span> torch.no_grad():<br>            <span class="hljs-keyword">try</span>:<br>                main_loop(phase=LoopPhase.VAL, epoch=epoch)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  <span class="hljs-comment"># &quot;å¿è€å·²ç»ç”¨å®Œ&quot; çš„å¼‚å¸¸ :O</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(e))<br>                <span class="hljs-keyword">break</span>  <span class="hljs-comment"># é€€å‡ºè®­ç»ƒå¾ªç¯</span><br><br>    <span class="hljs-comment"># æ­¥éª¤5ï¼šå¯èƒ½æµ‹è¯•æ‚¨çš„æ¨¡å‹</span><br>    <span class="hljs-comment"># ä¸è¦è¿‡åº¦æ‹Ÿåˆæµ‹è¯•æ•°æ®é›† - ä»…å½“æ‚¨åœ¨éªŒè¯æ•°æ®é›†ä¸Šå¾®è°ƒäº†æ¨¡å‹æ—¶ï¼Œæ‰åº”è¯¥æŠ¥å‘Šæµ‹è¯•æ•°æ®é›†ä¸Šçš„æœ€ç»ˆæŸå¤±å’Œå‡†ç¡®æ€§ã€‚</span><br>    <span class="hljs-keyword">if</span> config[<span class="hljs-string">&#x27;should_test&#x27;</span>]:<br>        test_acc = main_loop(phase=LoopPhase.TEST)<br>        config[<span class="hljs-string">&#x27;test_acc&#x27;</span>] = test_acc<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Test accuracy = <span class="hljs-subst">&#123;test_acc&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        config[<span class="hljs-string">&#x27;test_acc&#x27;</span>] = -<span class="hljs-number">1</span><br><br>    <span class="hljs-comment"># å°†æœ€æ–°çš„GATä¿å­˜åœ¨äºŒè¿›åˆ¶ç›®å½•ä¸­</span><br>    torch.save(get_training_state(config, gat), os.path.join(BINARIES_PATH, get_available_binary_name()))<br><br></code></pre></td></tr></table></figure>

<p>ğŸ‰ğŸ‰ğŸ‰</p>
<p>ç°åœ¨æ˜¯è®­ç»ƒçš„æ ¸å¿ƒéƒ¨åˆ† - ä¸»å¾ªç¯ï¼Œæ­£å¦‚æˆ‘æ‰€è¯´çš„é‚£æ ·ã€‚</p>
<p>æˆ‘è¿™æ ·ç»„ç»‡å®ƒï¼Œè¿™æ ·æˆ‘å°±ä¸å¿…ä¸ºè®­ç»ƒ&#x2F;éªŒè¯&#x2F;æµ‹è¯•å¾ªç¯å¤åˆ¶&#x2F;ç²˜è´´ä¸€å †ç›¸åŒçš„ä»£ç ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ç®€å•çš„è£…é¥°å‡½æ•°ï¼Œè¿™æ ·æˆ‘å°±ä¸å¿…ä¼ é€’ä»ä¸€ä¸ªæ—¶æœŸåˆ°å¦ä¸€ä¸ªæ—¶æœŸéƒ½ä¸å˜çš„å‚æ•°</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_main_loop</span>(<span class="hljs-params">config, gat, cross_entropy_loss, optimizer, node_features, node_labels, edge_index, train_indices, val_indices, test_indices, patience_period, time_start</span>):<br><br>    node_dim = <span class="hljs-number">0</span>  <span class="hljs-comment"># è¿™å¯èƒ½ä¼šåœ¨æˆ‘æ·»åŠ å½’çº³ç¤ºä¾‹ï¼ˆCoraæ˜¯å½’çº³çš„ï¼‰æ—¶å‘ç”Ÿå˜åŒ–</span><br><br>    train_labels = node_labels.index_select(node_dim, train_indices)<br>    val_labels = node_labels.index_select(node_dim, val_indices)<br>    test_labels = node_labels.index_select(node_dim, test_indices)<br><br>    <span class="hljs-comment"># node_features å½¢çŠ¶ = (N, FIN)ï¼Œedge_index å½¢çŠ¶ = (2, E)</span><br>    graph_data = (node_features, edge_index)  <span class="hljs-comment"># æˆ‘å°†æ•°æ®æ‰“åŒ…åˆ°å…ƒç»„ä¸­ï¼Œå› ä¸ºGATä½¿ç”¨nn.Sequentialï¼Œå®ƒè¦æ±‚è¿™æ ·åš</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_node_indices</span>(<span class="hljs-params">phase</span>):<br>        <span class="hljs-keyword">if</span> phase == LoopPhase.TRAIN:<br>            <span class="hljs-keyword">return</span> train_indices<br>        <span class="hljs-keyword">elif</span> phase == LoopPhase.VAL:<br>            <span class="hljs-keyword">return</span> val_indices<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> test_indices<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_node_labels</span>(<span class="hljs-params">phase</span>):<br>        <span class="hljs-keyword">if</span> phase == LoopPhase.TRAIN:<br>            <span class="hljs-keyword">return</span> train_labels<br>        <span class="hljs-keyword">elif</span> phase == LoopPhase.VAL:<br>            <span class="hljs-keyword">return</span> val_labels<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> test_labels<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">main_loop</span>(<span class="hljs-params">phase, epoch=<span class="hljs-number">0</span></span>):<br>        <span class="hljs-keyword">global</span> BEST_VAL_ACC, BEST_VAL_LOSS, PATIENCE_CNT, writer<br><br>        <span class="hljs-comment"># æŸäº›æ¨¡å—çš„è¡Œä¸ºå–å†³äºæˆ‘ä»¬æ˜¯å¦æ­£åœ¨è®­ç»ƒæ¨¡å‹ã€‚</span><br>        <span class="hljs-comment"># ä¾‹å¦‚ nn.Dropout - æˆ‘ä»¬åªæƒ³åœ¨è®­ç»ƒæœŸé—´ä¸¢å¼ƒæ¨¡å‹æƒé‡ã€‚</span><br>        <span class="hljs-keyword">if</span> phase == LoopPhase.TRAIN:<br>            gat.train()<br>        <span class="hljs-keyword">else</span>:<br>            gat.<span class="hljs-built_in">eval</span>()<br><br>        node_indices = get_node_indices(phase)<br>        gt_node_labels = get_node_labels(phase)  <span class="hljs-comment"># gt ä»£è¡¨ ground truthï¼ˆå®é™…æ ‡ç­¾ï¼‰</span><br><br>        <span class="hljs-comment"># è¿›è¡Œå‰å‘ä¼ æ’­å¹¶ä»…æå–ç›¸å…³èŠ‚ç‚¹å¾—åˆ†ï¼ˆtrain/valæˆ–testï¼‰</span><br>        <span class="hljs-comment"># æ³¨æ„ï¼š[0] åªæ˜¯æå–æ•°æ®çš„ node_features éƒ¨åˆ†ï¼ˆç´¢å¼• 1 åŒ…å« edge_indexï¼‰</span><br>        <span class="hljs-comment"># å½¢çŠ¶ = (N, C)ï¼Œå…¶ä¸­ N æ˜¯åˆ†å‰²ä¸­èŠ‚ç‚¹çš„æ•°é‡ï¼ˆtrain/val/testï¼‰ï¼ŒC æ˜¯ç±»çš„æ•°é‡</span><br>        nodes_unnormalized_scores = gat(graph_data)[<span class="hljs-number">0</span>].index_select(node_dim, node_indices)<br><br>        <span class="hljs-comment"># ä¾‹å¦‚ï¼šè®©æˆ‘ä»¬å– Cora ä¸Šå•ä¸ªèŠ‚ç‚¹çš„è¾“å‡º - å®ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸º 7 çš„å‘é‡ï¼ŒåŒ…å«æœªè§„èŒƒåŒ–çš„åˆ†æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</span><br>        <span class="hljs-comment"># V = [-1.393,  3.0765, -2.4445,  9.6219,  2.1658, -5.5243, -4.6247]</span><br>        <span class="hljs-comment"># PyTorchçš„äº¤å‰ç†µæŸå¤±æ‰€åšçš„æ˜¯ï¼Œå¯¹äºæ¯ä¸ªè¿™æ ·çš„å‘é‡ï¼Œé¦–å…ˆåº”ç”¨ softmaxï¼Œæ‰€ä»¥æˆ‘ä»¬å°† V è½¬æ¢ä¸ºï¼š</span><br>        <span class="hljs-comment"># [1.6421e-05, 1.4338e-03, 5.7378e-06, 0.99797, 5.7673e-04, 2.6376e-07, 6.4848e-07]</span><br>        <span class="hljs-comment"># å…¶æ¬¡ï¼Œæ— è®ºæ­£ç¡®ç±»åˆ«æ˜¯ä»€ä¹ˆï¼ˆå‡è®¾æ˜¯ 3ï¼‰ï¼Œå®ƒéƒ½å°†åœ¨ä½ç½® 3 å¤„å–å…ƒç´ ï¼Œ0.99797 åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ</span><br>        <span class="hljs-comment"># æŸå¤±å°†ä¸º -log(0.99797)ã€‚å¯¹äºæ¯ä¸ªèŠ‚ç‚¹ï¼Œå®ƒéƒ½ä¼šè¿™æ ·åšå¹¶åº”ç”¨å‡å€¼ã€‚</span><br>        <span class="hljs-comment"># å¯ä»¥çœ‹åˆ°ï¼Œéšç€å¤§å¤šæ•°èŠ‚ç‚¹çš„æ­£ç¡®ç±»åˆ«çš„æ¦‚ç‡æ¥è¿‘ 1ï¼ŒæŸå¤±è¶‹è¿‘äº 0ï¼ &lt;3</span><br>        loss = cross_entropy_loss(nodes_unnormalized_scores, gt_node_labels)<br><br>        <span class="hljs-keyword">if</span> phase == LoopPhase.TRAIN:<br>            optimizer.zero_grad()  <span class="hljs-comment"># æ¸…ç†è®¡ç®—å›¾ä¸­å¯è®­ç»ƒæƒé‡çš„æ¢¯åº¦ï¼ˆ.grad å­—æ®µï¼‰</span><br>            loss.backward()  <span class="hljs-comment"># ä¸ºè®¡ç®—å›¾ä¸­çš„æ¯ä¸ªå¯è®­ç»ƒæƒé‡è®¡ç®—æ¢¯åº¦</span><br>            optimizer.step()  <span class="hljs-comment"># å°†æ¢¯åº¦åº”ç”¨åˆ°æƒé‡ä¸Š</span><br><br>        <span class="hljs-comment"># æ‰¾åˆ°æ¯ä¸ªèŠ‚ç‚¹æœ€å¤§ï¼ˆæœªè§„èŒƒåŒ–ï¼‰å¾—åˆ†çš„ç´¢å¼•ï¼Œè¿™æ˜¯è¯¥èŠ‚ç‚¹çš„ç±»åˆ«é¢„æµ‹ã€‚</span><br>        <span class="hljs-comment"># å°†è¿™äº›ä¸çœŸå®ï¼ˆå®é™…æ ‡ç­¾ï¼‰æ ‡ç­¾è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶æ‰¾åˆ°æ­£ç¡®é¢„æµ‹çš„æ¯”ä¾‹ -&gt; å‡†ç¡®æ€§æŒ‡æ ‡ã€‚</span><br>        class_predictions = torch.argmax(nodes_unnormalized_scores, dim=-<span class="hljs-number">1</span>)<br>        accuracy = torch.<span class="hljs-built_in">sum</span>(torch.eq(class_predictions, gt_node_labels).long()).item() / <span class="hljs-built_in">len</span>(gt_node_labels)<br><br>        <span class="hljs-keyword">if</span> phase == LoopPhase.TRAIN:<br>            <span class="hljs-comment"># è®°å½•æŒ‡æ ‡</span><br>            <span class="hljs-keyword">if</span> config[<span class="hljs-string">&#x27;enable_tensorboard&#x27;</span>]:<br>                writer.add_scalar(<span class="hljs-string">&#x27;training_loss&#x27;</span>, loss.item(), epoch)<br>                writer.add_scalar(<span class="hljs-string">&#x27;training_acc&#x27;</span>, accuracy, epoch)<br><br>            <span class="hljs-comment"># ä¿å­˜æ¨¡å‹æ£€æŸ¥ç‚¹</span><br>            <span class="hljs-keyword">if</span> config[<span class="hljs-string">&#x27;checkpoint_freq&#x27;</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> (epoch + <span class="hljs-number">1</span>) % config[<span class="hljs-string">&#x27;checkpoint_freq&#x27;</span>] == <span class="hljs-number">0</span>:<br>                ckpt_model_name = <span class="hljs-string">f&quot;gat_ckpt_epoch_<span class="hljs-subst">&#123;epoch + <span class="hljs-number">1</span>&#125;</span>.pth&quot;</span><br>                config[<span class="hljs-string">&#x27;test_acc&#x27;</span>] = -<span class="hljs-number">1</span><br>                torch.save(get_training_state(config, gat), os.path.join(CHECKPOINTS_PATH, ckpt_model_name))<br><br>        <span class="hljs-keyword">elif</span> phase == LoopPhase.VAL:<br>            <span class="hljs-comment"># è®°å½•æŒ‡æ ‡</span><br>            <span class="hljs-keyword">if</span> config[<span class="hljs-string">&#x27;enable_tensorboard&#x27;</span>]:<br>                writer.add_scalar(<span class="hljs-string">&#x27;val_loss&#x27;</span>, loss.item(), epoch)<br>                writer.add_scalar(<span class="hljs-string">&#x27;val_acc&#x27;</span>, accuracy, epoch)<br><br>            <span class="hljs-comment"># è®°å½•åˆ°æ§åˆ¶å°</span><br>            <span class="hljs-keyword">if</span> config[<span class="hljs-string">&#x27;console_log_freq&#x27;</span>] <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> epoch % config[<span class="hljs-string">&#x27;console_log_freq&#x27;</span>] == <span class="hljs-number">0</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;GAT training: time elapsed= <span class="hljs-subst">&#123;(time.time() - time_start):<span class="hljs-number">.2</span>f&#125;</span> [s] | epoch=<span class="hljs-subst">&#123;epoch + <span class="hljs-number">1</span>&#125;</span> | val acc=<span class="hljs-subst">&#123;accuracy&#125;</span>&#x27;</span>)<br><br>            <span class="hljs-comment"># â€œè€å¿ƒâ€é€»è¾‘ - æˆ‘ä»¬æ˜¯å¦åº”è¯¥ä»è®­ç»ƒå¾ªç¯ä¸­é€€å‡ºï¼Ÿå¦‚æœéªŒè¯å‡†ç¡®æ€§ä¸æ–­æé«˜</span><br>            <span class="hljs-comment"># æˆ–éªŒè¯æŸå¤±ä¸æ–­ä¸‹é™ï¼Œæˆ‘ä»¬å°±ä¸ä¼šåœæ­¢</span><br>            <span class="hljs-keyword">if</span> accuracy &gt; BEST_VAL_ACC <span class="hljs-keyword">or</span> loss.item() &lt; BEST_VAL_LOSS:<br>                BEST_VAL_ACC = <span class="hljs-built_in">max</span>(accuracy, BEST_VAL_ACC)  <span class="hljs-comment"># è·Ÿè¸ªåˆ°ç›®å‰ä¸ºæ­¢çš„æœ€ä½³éªŒè¯å‡†ç¡®æ€§</span><br>                BEST_VAL_LOSS = <span class="hljs-built_in">min</span>(loss.item(), BEST_VAL_LOSS)<br>                PATIENCE_CNT = <span class="hljs-number">0</span>  <span class="hljs-comment"># æ¯æ¬¡é‡åˆ°æ–°çš„æœ€ä½³å‡†ç¡®æ€§æ—¶é‡ç½®è®¡æ•°å™¨</span><br>            <span class="hljs-keyword">else</span>:<br>                PATIENCE_CNT += <span class="hljs-number">1</span>  <span class="hljs-comment"># å¦åˆ™ç»§ç»­è®¡æ•°</span><br><br>            <span class="hljs-keyword">if</span> PATIENCE_CNT &gt;= patience_period:<br>                <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;åœæ­¢è®­ç»ƒï¼Œå®‡å®™å¯¹è¿™æ¬¡è®­ç»ƒæ²¡æœ‰æ›´å¤šçš„è€å¿ƒäº†ã€‚&#x27;</span>)<br><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> accuracy  <span class="hljs-comment"># åœ¨æµ‹è¯•é˜¶æ®µï¼Œæˆ‘ä»¬åªè¿”å›æµ‹è¯•å‡†ç¡®æ€§</span><br><br>    <span class="hljs-keyword">return</span> main_loop  <span class="hljs-comment"># è¿”å›è£…é¥°å‡½æ•°</span><br><br></code></pre></td></tr></table></figure>

<p>å¼€å§‹è®­ç»ƒå§</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Train the graph attention network (GAT)</span><br>train_gat(get_training_args())<br></code></pre></td></tr></table></figure>

<pre><code class="hljs">/var/folders/f0/812mfv7x63vbytjs3yf4gxtc0000gn/T/ipykernel_16269/2448994618.py:6: DeprecationWarning: Please use `csr_matrix` from the `scipy.sparse` namespace, the `scipy.sparse.csr` namespace is deprecated.
  data = pickle.load(file)


GAT training: time elapsed= 0.22 [s] | epoch=1 | val acc=0.124
GAT training: time elapsed= 5.56 [s] | epoch=101 | val acc=0.79
GAT training: time elapsed= 10.72 [s] | epoch=201 | val acc=0.8
GAT training: time elapsed= 15.92 [s] | epoch=301 | val acc=0.8
GAT training: time elapsed= 21.13 [s] | epoch=401 | val acc=0.782
GAT training: time elapsed= 26.34 [s] | epoch=501 | val acc=0.784
GAT training: time elapsed= 31.68 [s] | epoch=601 | val acc=0.816
GAT training: time elapsed= 36.79 [s] | epoch=701 | val acc=0.804
GAT training: time elapsed= 41.91 [s] | epoch=801 | val acc=0.806
GAT training: time elapsed= 47.01 [s] | epoch=901 | val acc=0.814
GAT training: time elapsed= 52.20 [s] | epoch=1001 | val acc=0.81
GAT training: time elapsed= 57.41 [s] | epoch=1101 | val acc=0.798
GAT training: time elapsed= 62.52 [s] | epoch=1201 | val acc=0.816
GAT training: time elapsed= 67.61 [s] | epoch=1301 | val acc=0.796
GAT training: time elapsed= 72.71 [s] | epoch=1401 | val acc=0.79
GAT training: time elapsed= 77.82 [s] | epoch=1501 | val acc=0.812
GAT training: time elapsed= 82.94 [s] | epoch=1601 | val acc=0.796
GAT training: time elapsed= 88.08 [s] | epoch=1701 | val acc=0.798
GAT training: time elapsed= 93.26 [s] | epoch=1801 | val acc=0.794
GAT training: time elapsed= 98.39 [s] | epoch=1901 | val acc=0.8
GAT training: time elapsed= 103.64 [s] | epoch=2001 | val acc=0.806
åœæ­¢è®­ç»ƒï¼Œå®‡å®™å¯¹è¿™æ¬¡è®­ç»ƒæ²¡æœ‰æ›´å¤šçš„è€å¿ƒäº†ã€‚
Test accuracy = 0.817
</code></pre>
<p>å¥½çš„ï¼ï¼ï¼ğŸ‰ğŸ‰ğŸ‰ 4 çº§è§£é”ï¼ˆGAT å¯è§†åŒ–ğŸ”®ï¼‰ã€‚</p>
<p>æˆ‘ä»¬åˆšåˆš82.9 %åœ¨ Cora çš„æµ‹è¯•èŠ‚ç‚¹ä¸Šå®ç°äº†ï¼ä¸åŸå§‹ GAT è®ºæ–‡ä¸­æŠ¥å‘Šçš„æ•°å­—ç›¸åŒï¼</p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»ä¸€åˆ‡å°±ç»ªï¼š</p>
<ol>
<li>æ•°æ®åŠ è½½å’Œå¯è§†åŒ–ğŸ“œ -&gt; ç¡®è®¤</li>
<li>GAT æ¨¡å‹å®šä¹‰ ğŸ¦„ -&gt; ç¡®è®¤</li>
<li>è®­ç»ƒå¾ªç¯è®¾ç½®å’Œè®­ç»ƒåçš„æ¨¡å‹äºŒè¿›åˆ¶æ–‡ä»¶ ğŸ’ª -&gt; ç¡®è®¤</li>
</ol>
<p>ç°åœ¨è®©æˆ‘ä»¬åœ¨æ˜¾å¾®é•œğŸ”¬ä¸‹è§‚å¯Ÿ GAT æ¨¡å‹å¹¶äº†è§£æˆ‘ä»¬å¾—åˆ°çš„æƒé‡ - æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼åšåˆ°è¿™ç‚¹ã€‚</p>
<h1 id="ç¬¬-4-éƒ¨åˆ†ï¼šå¯è§†åŒ–-GAT-ğŸ”®"><a href="#ç¬¬-4-éƒ¨åˆ†ï¼šå¯è§†åŒ–-GAT-ğŸ”®" class="headerlink" title="ç¬¬ 4 éƒ¨åˆ†ï¼šå¯è§†åŒ– GAT ğŸ”®"></a>ç¬¬ 4 éƒ¨åˆ†ï¼šå¯è§†åŒ– GAT ğŸ”®</h1><p>è®©æˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸€äº›æˆ‘ä»¬éœ€è¦çš„å‡½æ•°ã€‚</p>
<p>ä»¥ä¸‹å•å…ƒæ ¼çš„ä»£ç ç‰‡æ®µå°†è¢«å¤šæ¬¡è°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬å°†å…¶æå–åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ - ä¸€ä¸ªå¾ˆå¥½çš„æ¨¡å—åŒ–è®¾è®¡ã€‚</p>
<p>æ³¨æ„ï¼šä¸»è¦åŸå› å®é™…ä¸Šæ˜¯ igraph åœ¨ Jupyter ä¸Šå‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘æ­£åœ¨è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¦‚æœä½ å¥½å¥‡çš„è¯ï¼Œè¯·æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://github.com/gordicaleksa/pytorch-GAT/blob/main/playground.py#L147">åŸå§‹ä»£ç </a> ğŸ˜‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">gat_forward_pass</span>(<span class="hljs-params">model_name, dataset_name</span>):<br>    device = torch.device(<span class="hljs-string">&quot;cuda&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span>)  <span class="hljs-comment"># æ£€æŸ¥æ˜¯å¦æœ‰ GPUï¼Œå¸Œæœ›æœ‰ï¼</span><br><br>    config = &#123;<br>        <span class="hljs-string">&#x27;dataset_name&#x27;</span>: dataset_name,<br>        <span class="hljs-string">&#x27;should_visualize&#x27;</span>: <span class="hljs-literal">False</span>  <span class="hljs-comment"># ä¸å¯è§†åŒ–æ•°æ®é›†</span><br>    &#125;<br><br>    <span class="hljs-comment"># æ­¥éª¤ 1ï¼šå‡†å¤‡æ•°æ®</span><br>    node_features, node_labels, edge_index, _, _, _ = load_graph_data(config, device)<br><br>    <span class="hljs-comment"># æ­¥éª¤ 2ï¼šå‡†å¤‡æ¨¡å‹</span><br>    model_path = os.path.join(BINARIES_PATH, model_name)<br>    model_state = torch.load(model_path, map_location=torch.device(<span class="hljs-string">&#x27;cpu&#x27;</span>))<br><br>    gat = GAT(<br>        num_of_layers=model_state[<span class="hljs-string">&#x27;num_of_layers&#x27;</span>],<br>        num_heads_per_layer=model_state[<span class="hljs-string">&#x27;num_heads_per_layer&#x27;</span>],<br>        num_features_per_layer=model_state[<span class="hljs-string">&#x27;num_features_per_layer&#x27;</span>],<br>        add_skip_connection=model_state[<span class="hljs-string">&#x27;add_skip_connection&#x27;</span>],<br>        bias=model_state[<span class="hljs-string">&#x27;bias&#x27;</span>],<br>        dropout=model_state[<span class="hljs-string">&#x27;dropout&#x27;</span>],<br>        log_attention_weights=<span class="hljs-literal">True</span><br>    ).to(device)<br><br>    print_model_metadata(model_state)<br>    gat.load_state_dict(model_state[<span class="hljs-string">&quot;state_dict&quot;</span>], strict=<span class="hljs-literal">True</span>)<br>    gat.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># ä¸€äº›å±‚ï¼Œæ¯”å¦‚ nn.Dropoutï¼Œåœ¨è®­ç»ƒæ¨¡å¼å’Œè¯„ä¼°æ¨¡å¼ä¸‹çš„è¡Œä¸ºæ˜¯ä¸åŒçš„ï¼Œå› æ­¤è¿™ä¸€éƒ¨åˆ†å¾ˆé‡è¦</span><br><br>    <span class="hljs-comment"># æ­¥éª¤ 3ï¼šè®¡ç®—æˆ‘ä»¬å°†éœ€è¦ä¸åŒå¯è§†åŒ–ç±»å‹çš„æ‰€æœ‰ä¸œè¥¿ï¼ˆæ³¨æ„åŠ›ã€åˆ†æ•°ã€edge_indexï¼‰</span><br><br>    <span class="hljs-comment"># è¿™ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨å¾ˆé‡è¦ï¼ˆä½ ç»å¸¸ä¼šçœ‹åˆ°å®ƒï¼‰ï¼Œå¦åˆ™ PyTorch ä¼šå ç”¨æ›´å¤šå†…å­˜ã€‚</span><br>    <span class="hljs-comment"># å®ƒä¼šä¿å­˜åå‘ä¼ æ’­çš„æ¿€æ´»ï¼Œä½†æˆ‘ä»¬ä¸ä¼šè¿›è¡Œä»»ä½•æ¨¡å‹è®­ç»ƒï¼Œåªæ˜¯é¢„æµ‹ã€‚</span><br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        <span class="hljs-comment"># æ­¥éª¤ 3ï¼šè¿è¡Œé¢„æµ‹å¹¶æ”¶é›†é«˜ç»´æ•°æ®</span><br>        all_nodes_unnormalized_scores, _ = gat((node_features, edge_index))  <span class="hljs-comment"># å½¢çŠ¶ = (N, ç±»åˆ«æ•°)</span><br>        all_nodes_unnormalized_scores = all_nodes_unnormalized_scores.cpu().numpy()<br><br>    <span class="hljs-keyword">return</span> all_nodes_unnormalized_scores, edge_index, node_labels, gat<br><br></code></pre></td></tr></table></figure>

<p>å¾ˆé«˜å…´åªç”Ÿæˆå°†åœ¨ä¸‹æ¸¸å¯è§†åŒ–ä¸­ä½¿ç”¨çš„æ•°æ®ï¼Œæ‚¨å°†åœ¨ä»¥ä¸‹å•å…ƒæ ¼ä¸­çœ‹åˆ°å®šä¹‰çš„æ•°æ®ã€‚</p>
<p>æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œå·²ç»å‡†å¤‡å¥½äº†ï¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ç»˜åˆ¶ï¼ˆä½†å°šæœªç»˜åˆ¶ï¼‰ç†µç›´æ–¹å›¾ã€‚å¦‚æœä½ å¯¹ä¸ºä»€ä¹ˆçªç„¶å‡ºç°ç†µæ„Ÿåˆ°å›°æƒ‘ï¼Œè¯·è·Ÿæˆ‘èµ°ï¼Œä½ å¾ˆå¿«å°±ä¼šæ˜ç™½çš„ã€‚</span><br><span class="hljs-comment"># åŸºæœ¬ä¸Šï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬é‡åŒ– GAT å­¦åˆ°çš„æ³¨æ„åŠ›æ¨¡å¼çš„æœ‰ç”¨æ€§ã€‚</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">draw_entropy_histogram</span>(<span class="hljs-params">entropy_array, title, color=<span class="hljs-string">&#x27;blue&#x27;</span>, uniform_distribution=<span class="hljs-literal">False</span>, num_bins=<span class="hljs-number">30</span></span>):<br>    max_value = np.<span class="hljs-built_in">max</span>(entropy_array)<br>    bar_width = (max_value / num_bins) * (<span class="hljs-number">1.0</span> <span class="hljs-keyword">if</span> uniform_distribution <span class="hljs-keyword">else</span> <span class="hljs-number">0.75</span>)<br>    histogram_values, histogram_bins = np.histogram(entropy_array, bins=num_bins, <span class="hljs-built_in">range</span>=(<span class="hljs-number">0.0</span>, max_value))<br><br>    plt.bar(histogram_bins[:num_bins], histogram_values[:num_bins], width=bar_width, color=color)<br>    plt.xlabel(<span class="hljs-string">f&#x27;ç†µåŒºé—´&#x27;</span>)<br>    plt.ylabel(<span class="hljs-string">f&#x27;èŠ‚ç‚¹é‚»å±…æ•°é‡&#x27;</span>)<br>    plt.title(title)<br><br></code></pre></td></tr></table></figure>

<p>å¾ˆå¥½ï¼Œæ¥ä¸‹æ¥æ˜¯æˆ‘ä»¬å°†ç”¨æ¥å¯è§†åŒ– GAT åµŒå…¥ï¼ˆé€šè¿‡ t-SNEï¼‰å’Œç†µç›´æ–¹å›¾çš„ä¸»è¦å‡½æ•°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sklearn.manifold <span class="hljs-keyword">import</span> TSNE<br><span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> entropy<br><br><br><span class="hljs-comment"># è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæšä¸¾ä½œä¸ºé€‰æ‹©ä¸åŒå¯è§†åŒ–é€‰é¡¹çš„æ¸…æ™°æ–¹å¼</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">VisualizationType</span>(enum.Enum):<br>    ATTENTION = <span class="hljs-number">0</span>,<br>    EMBEDDINGS = <span class="hljs-number">1</span>,<br>    ENTROPY = <span class="hljs-number">2</span>,<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">visualize_gat_properties</span>(<span class="hljs-params">model_name=<span class="hljs-string">r&#x27;gat_000000.pth&#x27;</span>, dataset_name=DatasetType.CORA.name, visualization_type=VisualizationType.ATTENTION</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    åœ¨å¯è§†åŒ–é€‰é¡¹ä¹‹é—´é€‰æ‹© t-SNE æˆ–ç†µç›´æ–¹å›¾ã€‚</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    t-SNE çš„æ³¨æ„äº‹é¡¹ï¼š</span><br><span class="hljs-string">    æŸ¥çœ‹æ­¤é“¾æ¥ä»¥è·å–æœ‰å…³å¦‚ä½•è°ƒæ•´ t-SNE çš„æ›´å¤šç›´è§‚ä¿¡æ¯ï¼šhttps://distill.pub/2016/misread-tsne/</span><br><span class="hljs-string"></span><br><span class="hljs-string">    å¦‚æœæ‚¨è®¤ä¸ºå®ç° t-SNE å¹¶è§£é‡Šæ¯ä¸ªç»†èŠ‚çš„æœ‰ç”¨æ€§ï¼Œå¹¶ä¸”æ„¿æ„è®©æˆ‘çŸ¥é“ï¼Œå¯ä»¥æ‰“å¼€ä¸€ä¸ªé—®é¢˜æˆ–åœ¨ç¤¾äº¤åª’ä½“ä¸Šç§ä¿¡æˆ‘ï¼&lt;3</span><br><span class="hljs-string"></span><br><span class="hljs-string">    æ³¨æ„ï¼šæˆ‘è¿˜å°è¯•è¿‡ä½¿ç”¨ UMAPï¼Œä½†å®ƒå¹¶æ²¡æœ‰æä¾›æ¯” t-SNE æ›´å¤šçš„è§è§£ã€‚</span><br><span class="hljs-string">    ï¼ˆç¼ºç‚¹ï¼šå¦‚æœè¦ä½¿ç”¨å…¶ç»˜å›¾åŠŸèƒ½ï¼Œå®ƒæœ‰å¾ˆå¤šä¾èµ–é¡¹ï¼‰</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <br>    <span class="hljs-comment"># è·å–åˆ›å»ºå¯è§†åŒ–æ‰€éœ€çš„æ•°æ®</span><br>    all_nodes_unnormalized_scores, edge_index, node_labels, gat = gat_forward_pass(model_name, dataset_name)<br>    <br>    <span class="hljs-comment"># æ‰§è¡Œç‰¹å®šçš„å¯è§†åŒ–ï¼ˆt-SNE æˆ–ç†µç›´æ–¹å›¾ï¼‰</span><br>    <span class="hljs-keyword">if</span> visualization_type == VisualizationType.EMBEDDINGS:  <span class="hljs-comment"># å¯è§†åŒ–åµŒå…¥ï¼ˆä½¿ç”¨ t-SNEï¼‰</span><br>        node_labels = node_labels.cpu().numpy()<br>        num_classes = <span class="hljs-built_in">len</span>(<span class="hljs-built_in">set</span>(node_labels))<br><br>        <span class="hljs-comment"># å¤šå°è¯• perplexityï¼Œè¿™å¯èƒ½æ˜¯ t-SNE ä¸­æœ€é‡è¦çš„å‚æ•°ä¹‹ä¸€ï¼Œå®ƒåŸºæœ¬ä¸Šæ§åˆ¶äº†é«˜ç»´ï¼ˆåŸå§‹ï¼‰ç©ºé—´ä¸­ Gaussians çš„æ ‡å‡†å·®ï¼Œå³é«˜ç»´ç©ºé—´ä¸­é‚»å±…çš„å¤§å°ã€‚</span><br>        <span class="hljs-comment"># ç®€è€Œè¨€ä¹‹ï¼Œt-SNE çš„ç›®æ ‡æ˜¯æœ€å°åŒ–é«˜ç»´ç‚¹ä¸Šæ‹Ÿåˆçš„è”åˆé«˜æ–¯åˆ†å¸ƒä¸ä½ç»´ç‚¹ä¸Šæ‹Ÿåˆçš„ t-Student åˆ†å¸ƒä¹‹é—´çš„ KL æ•£åº¦</span><br>        <span class="hljs-comment"># ç›´è§‚åœ°è¯´ï¼Œé€šè¿‡è¿™æ ·åšï¼Œæˆ‘ä»¬ä¿ç•™äº†é«˜ç»´å’Œä½ç»´ç‚¹ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼ˆå…³ç³»ï¼‰ã€‚</span><br>        <span class="hljs-comment"># å¦‚æœæ‚¨å¯¹ t-SNEå°šä¸ç†Ÿæ‚‰ï¼Œè¿™å¯èƒ½ä¸ä¼šæœ‰å¤ªå¤šæ„ä¹‰ï¼Œæˆ‘å·²ç»å°è¯•è¿‡äº†ã€‚:P</span><br>        t_sne_embeddings = TSNE(n_components=<span class="hljs-number">2</span>, perplexity=<span class="hljs-number">30</span>, method=<span class="hljs-string">&#x27;barnes_hut&#x27;</span>).fit_transform(all_nodes_unnormalized_scores)<br><br>        fig = plt.figure(figsize=(<span class="hljs-number">12</span>,<span class="hljs-number">8</span>), dpi=<span class="hljs-number">80</span>)  <span class="hljs-comment"># å¦åˆ™åœ¨ Jupyter Notebook ä¸­ï¼Œç»˜å›¾ä¼šå¾ˆå°</span><br>        <span class="hljs-keyword">for</span> class_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_classes):<br>            <span class="hljs-comment"># æˆ‘ä»¬æå–çœŸå®æ ‡ç­¾ç­‰äº class_id çš„ç‚¹ï¼Œå¹¶ä»¥ç›¸åŒçš„æ–¹å¼å¯¹å®ƒä»¬è¿›è¡Œç€è‰²ï¼Œå¸Œæœ›å®ƒä»¬åœ¨ 2D å›¾ä¸Šèšé›†åœ¨ä¸€èµ· -</span><br>            <span class="hljs-comment"># è¿™æ„å‘³ç€ GAT å·²ç»å­¦åˆ°äº†å¾ˆå¥½çš„è¡¨ç¤ºï¼</span><br>            plt.scatter(t_sne_embeddings[node_labels == class_id, <span class="hljs-number">0</span>], t_sne_embeddings[node_labels == class_id, <span class="hljs-number">1</span>], s=<span class="hljs-number">20</span>, color=cora_label_to_color_map[class_id], edgecolors=<span class="hljs-string">&#x27;black&#x27;</span>, linewidths=<span class="hljs-number">0.2</span>)<br>        plt.show()<br><br>    <span class="hljs-comment"># æˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„å±€éƒ¨æ¦‚ç‡åˆ†å¸ƒï¼ˆå¯¹é‚»å±…çš„æ³¨æ„åŠ›æƒé‡ï¼‰æ˜¯éå‡åŒ€çš„ï¼Œå› ä¸ºè¿™æ„å‘³ç€ GAT å­¦åˆ°äº†æœ‰ç”¨çš„æ¨¡å¼ã€‚ç†µç›´æ–¹å›¾å¸®åŠ©æˆ‘ä»¬å¯è§†åŒ–</span><br>    <span class="hljs-comment"># è¿™äº›é‚»å±…åˆ†å¸ƒä¸å‡åŒ€åˆ†å¸ƒï¼ˆå¸¸æ•°å…³æ³¨ï¼‰æœ‰å¤šä¹ˆä¸åŒã€‚å¦‚æœ GAT å­¦åˆ°äº†å¸¸é‡æ³¨æ„åŠ›ï¼Œæˆ‘ä»¬å¯èƒ½å¾ˆå¥½åœ°ä½¿ç”¨ GCN æˆ–ä¸€äº›æ›´ç®€å•çš„æ¨¡å‹ã€‚</span><br>    <span class="hljs-keyword">elif</span> visualization_type == VisualizationType.ENTROPY:<br>        num_heads_per_layer = [layer.num_of_heads <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> gat.gat_net]<br>        num_layers = <span class="hljs-built_in">len</span>(num_heads_per_layer)<br><br>        num_of_nodes = <span class="hljs-built_in">len</span>(node_features)<br>        target_node_ids = edge_index[<span class="hljs-number">1</span>].cpu().numpy()<br><br>        <span class="hljs-comment"># å¯¹äºæ¯ä¸ª GAT å±‚å’Œæ¯ä¸ª GAT æ³¨æ„åŠ›å¤´ï¼Œç»˜åˆ¶ç†µç›´æ–¹å›¾</span><br>        <span class="hljs-keyword">for</span> layer_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_layers):<br>            <span class="hljs-comment"># è·å–è¾¹ç¼˜çš„æ³¨æ„åŠ›æƒé‡ï¼ˆåœ¨ä¸Šé¢çš„ GAT æ­£å‘ä¼ é€’æœŸé—´è®°å½•äº†æ³¨æ„åŠ›ï¼‰</span><br>            <span class="hljs-comment"># æ³¨æ„åŠ›å½¢çŠ¶ = (N, NH, 1) -&gt; (N, NH) - æˆ‘ä»¬åªæŒ¤å‹äº†æœ€åä¸€ä¸ªç»´åº¦ï¼Œå®ƒæ˜¯å¤šä½™çš„</span><br>            all_attention_weights = gat.gat_net[layer_id].attention_weights.squeeze(dim=-<span class="hljs-number">1</span>).cpu().numpy()<br><br>            <span class="hljs-keyword">for</span> head_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_heads_per_layer[layer_id]):<br>                uniform_dist_entropy_list = []  <span class="hljs-comment"># å°†ç†æƒ³çš„å‡åŒ€ç›´æ–¹å›¾ä¿å­˜ä¸ºå‚è€ƒ</span><br>                neighborhood_entropy_list = []<br><br>                <span class="hljs-comment"># è¿™ä¹Ÿå¯ä»¥é€šè¿‡ scatter_add_ï¼ˆæ²¡æœ‰ for å¾ªç¯ï¼‰æ›´æœ‰æ•ˆåœ°å®Œæˆ</span><br>                <span class="hljs-comment"># ä¼ªï¼šout.scatter_add_(node_dim, -all_attention_weights * log(all_attention_weights), target_index)</span><br>                <span class="hljs-keyword">for</span> target_node_id <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_of_nodes):  <span class="hljs-comment"># æ‰¾åˆ°å›¾ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„é‚»å±…</span><br>                    <span class="hljs-comment"># è¿™äº›æ³¨æ„åŠ›æƒé‡æ€»å’Œä¸º 1ï¼Œå› ä¸º GAT çš„è®¾è®¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å…¶è§†ä¸ºæ¦‚ç‡åˆ†å¸ƒ</span><br>                    neigborhood_attention = all_attention_weights[target_node_ids == target_node_id].flatten()<br>                    <span class="hljs-comment"># åŒæ ·é•¿åº¦çš„å‚è€ƒå‡åŒ€åˆ†å¸ƒ</span><br>                    ideal_uniform_attention = np.ones(<span class="hljs-built_in">len</span>(neigborhood_attention))/<span class="hljs-built_in">len</span>(neigborhood_attention)<br><br>                    <span class="hljs-comment"># è®¡ç®—ç†µï¼Œå¦‚æœæ‚¨å¯¹è¯¥æ¦‚å¿µä¸ç†Ÿæ‚‰ï¼Œè¯·æŸ¥çœ‹æ­¤è§†é¢‘ï¼š</span><br>                    <span class="hljs-comment"># https://www.youtube.com/watch?v=ErfnhcEV1O8ï¼ˆAurÃ©lien GÃ©ronï¼‰</span><br>                    neighborhood_entropy_list.append(entropy(neigborhood_attention, base=<span class="hljs-number">2</span>))<br>                    uniform_dist_entropy_list.append(entropy(ideal_uniform_attention, base=<span class="hljs-number">2</span>))<br><br>                title = <span class="hljs-string">f&#x27;Cora ç†µç›´æ–¹å›¾ å±‚=<span class="hljs-subst">&#123;layer_id&#125;</span>ï¼Œæ³¨æ„åŠ›å¤´=<span class="hljs-subst">&#123;head_id&#125;</span>&#x27;</span><br>                draw_entropy_histogram(uniform_dist_entropy_list, title, color=<span class="hljs-string">&#x27;orange&#x27;</span>, uniform_distribution=<span class="hljs-literal">True</span>)<br>                draw_entropy_histogram(neighborhood_entropy_list, title, color=<span class="hljs-string">&#x27;dodgerblue&#x27;</span>)<br><br>                fig = plt.gcf()  <span class="hljs-comment"># è·å–å½“å‰å›¾å½¢</span><br>                plt.show()<br>                fig.savefig(os.path.join(DATA_DIR_PATH, <span class="hljs-string">f&#x27;layer_<span class="hljs-subst">&#123;layer_id&#125;</span>_head_<span class="hljs-subst">&#123;head_id&#125;</span>.jpg&#x27;</span>))<br>                plt.close()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f&#x27;ä¸æ”¯æŒçš„å¯è§†åŒ–ç±»å‹ <span class="hljs-subst">&#123;visualization_type&#125;</span>ã€‚&#x27;</span>)<br><br></code></pre></td></tr></table></figure>

<p>å¥½çš„ï¼æœ€åè®©æˆ‘ä»¬ç”¨ç”¨å§ï¼é¦–å…ˆæ˜¯-t-SNEã€‚</p>
<h1 id="ä½¿ç”¨-t-SNE-å¯è§†åŒ–-GAT-çš„åµŒå…¥-ğŸ“ˆ"><a href="#ä½¿ç”¨-t-SNE-å¯è§†åŒ–-GAT-çš„åµŒå…¥-ğŸ“ˆ" class="headerlink" title="ä½¿ç”¨ t-SNE å¯è§†åŒ– GAT çš„åµŒå…¥ ğŸ“ˆ"></a>ä½¿ç”¨ t-SNE å¯è§†åŒ– GAT çš„åµŒå…¥ ğŸ“ˆ</h1><p>t-SNE å±äºä¸€å¤§ç±»é™ç»´æ–¹æ³•ã€‚</p>
<p>å®ƒåœ¨ç¤¾åŒºä¸­è·å¾—äº†å·¨å¤§çš„å…³æ³¨ï¼Œå› ä¸ºå®ƒä½¿ç”¨ç®€å•å¹¶ä¸”æ•ˆæœè‰¯å¥½ï¼ˆå¯èƒ½æ˜¯å› ä¸ºå®ƒæ˜¯ç”± Geoffrey Hinton khmå…±åŒåˆ›ä½œçš„ï¼‰</p>
<p>è¿˜æœ‰å…¶ä»–è¾ƒæ–°çš„æ–¹æ³•æ¯”å¦‚UMAPï¼Œä½†å°šæœªè·å¾—è¶³å¤Ÿçš„å…³æ³¨ï¼ˆæ®æˆ‘æ‰€çŸ¥ï¼‰ã€‚</p>
<p>ä½†ç†è®ºå·²ç»è¶³å¤Ÿäº†ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€äº›å›¾è¡¨ï¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">model_name=<span class="hljs-string">r&#x27;gat_000000.pth&#x27;</span>  <span class="hljs-comment"># This model is checked-in, feel free to use the one you trained</span><br>dataset_name=DatasetType.CORA.name<br><br><br>visualize_gat_properties(<br>        model_name,<br>        dataset_name,<br>        visualization_type=VisualizationType.EMBEDDINGS  <span class="hljs-comment"># pick between attention, t-SNE embeddings and entropy</span><br>)<br></code></pre></td></tr></table></figure>

<pre><code class="hljs">/var/folders/f0/812mfv7x63vbytjs3yf4gxtc0000gn/T/ipykernel_16269/2448994618.py:6: DeprecationWarning: Please use `csr_matrix` from the `scipy.sparse` namespace, the `scipy.sparse.csr` namespace is deprecated.
  data = pickle.load(file)



***** æ¨¡å‹è®­ç»ƒå…ƒæ•°æ®: *****
commit_hash: 91fb864b8f9ddefd401bf5399cea779bd3c0a63b
dataset_name: CORA
num_of_epochs: 10000
test_acc: 0.822
num_of_layers: 2
num_heads_per_layer: [8, 1]
num_features_per_layer: [1433, 8, 7]
add_skip_connection: False
bias: True
dropout: 0.6
layer_type: IMP3
*********************



/Users/gawaintan/miniforge3/envs/torch/lib/python3.9/site-packages/IPython/core/pylabtools.py:152: UserWarning: Glyph 8722 (\N&#123;MINUS SIGN&#125;) missing from current font.
  fig.canvas.print_figure(bytes_io, **kw)
</code></pre>
<p><img src="https://ptpimg.me/yt72e1.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"></p>
<p>æ¼‚äº®ï¼</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ - ä¸€æ—¦æˆ‘ä»¬é€šè¿‡ GAT è¿›è¡Œå‰å‘ä¼ é€’ï¼Œå®ƒå°±ä¼šå°†ç»´åº¦ï¼ˆèŠ‚ç‚¹æ•°ã€æ¯ä¸ªç‰¹å¾å‘é‡çš„ç‰¹å¾æ•°ï¼‰&#x3D; çš„è¾“å…¥ç‰¹å¾å‘é‡è½¬æ¢ä¸º å› ä¸º Cora æœ‰ 7 ä¸ª(2708, 1433)ç±»(2708, 7)ã€‚</p>
<p>è¿™äº›ç±»æ˜¯ï¼šGenetic Algorithmsã€Reinforcement Learningç­‰ï¼Œä½¿å…¶ä¸é‚£ä¹ˆæŠ½è±¡ï¼Œä½†æœ€ç»ˆå®ƒé€‚ç”¨äºä»»ä½• 7 ä¸ªç±»çš„é›†åˆå¹¶ä¸é‡è¦ã€‚</p>
<p>ç°åœ¨ï¼Œä¸€æ—¦æˆ‘ä»¬è·å¾—äº† 7 ç»´å‘é‡ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ t-SNE å°†å®ƒä»¬æ˜ å°„åˆ° 2D å‘é‡ï¼ˆå› ä¸ºä½ çŸ¥é“å¾ˆéš¾ç»˜åˆ¶ 7D å‘é‡ï¼‰ã€‚t-SNE çš„æŠ€å·§åœ¨äºï¼Œå®ƒä¿ç•™äº†å‘é‡ä¹‹é—´çš„å…³ç³»ï¼Œå› æ­¤ï¼Œç²—ç•¥åœ°è¯´ï¼Œå¦‚æœå®ƒä»¬åœ¨ 7D ç©ºé—´ä¸­æ¥è¿‘ï¼ˆä½†æ˜¯æˆ‘ä»¬å®šä¹‰â€œæ¥è¿‘åº¦â€ï¼‰ï¼Œé‚£ä¹ˆå®ƒä»¬åœ¨ 2D ç©ºé—´ä¸­ä¹Ÿä¼šæ¥è¿‘ã€‚</p>
<p>ç°åœ¨æ‚¨å¯ä»¥çœ‹åˆ°åŒä¸€ç±»çš„ç‚¹ï¼ˆå®ƒä»¬å…·æœ‰ç›¸åŒçš„é¢œè‰²ï¼‰èšé›†åœ¨ä¸€èµ·ï¼è¿™æ˜¯ä¸€ä¸ªç†æƒ³çš„ç‰¹æ€§ï¼Œå› ä¸ºç°åœ¨è®­ç»ƒä¸€ä¸ªèƒ½å¤Ÿæ­£ç¡®é¢„æµ‹ç±»åˆ«çš„åˆ†ç±»å™¨è¦å®¹æ˜“å¾—å¤šã€‚</p>
<hr>
<p>å¤ªæ£’äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬å°†æ³¨æ„åŠ›è½¬ç§»åˆ°æ³¨æ„åŠ›ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬æ¯•ç«Ÿæ­£åœ¨å¤„ç†å›¾æ³¨æ„åŠ›ç½‘ç»œã€‚</p>
<h1 id="å¯è§†åŒ–é‚»å±…çš„æ³¨æ„åŠ›ğŸ“£"><a href="#å¯è§†åŒ–é‚»å±…çš„æ³¨æ„åŠ›ğŸ“£" class="headerlink" title="å¯è§†åŒ–é‚»å±…çš„æ³¨æ„åŠ›ğŸ“£"></a>å¯è§†åŒ–é‚»å±…çš„æ³¨æ„åŠ›ğŸ“£</h1><p>æ‰€ä»¥ï¼Œä½ ç°åœ¨å¸Œæœ›äº†è§£ GAT çš„å¤§è‡´å·¥ä½œåŸç†ï¼Œå¹¶ä¸”çŸ¥é“åœ¨èšåˆé˜¶æ®µï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šä¸ºå…¶æ¯ä¸ªé‚»å±…åˆ†é…ä¸€ä¸ªæ³¨æ„åŠ›ç³»æ•°ï¼ˆåŒ…æ‹¬å®ƒè‡ªå·±ï¼Œå› ä¸ºæˆ‘ä»¬æ·»åŠ äº†è‡ªè¾¹ï¼‰ã€‚</p>
<p>å…³äºæˆ‘ä»¬å¯ä»¥æƒ³è±¡ä»€ä¹ˆæœ‰ä»€ä¹ˆæƒ³æ³•å—ï¼Ÿå¥½å§ï¼Œè®©æˆ‘ä»¬é€‰æ‹©ä¸€äº›èŠ‚ç‚¹ï¼Œçœ‹çœ‹ä»–ä»¬å­¦åˆ°äº†å“ªäº›æ³¨æ„åŠ›æ¨¡å¼ï¼</p>
<p>æ‚¨å¯èƒ½æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯ï¼Œå¦‚æœæ³¨æ„åŠ›è¾ƒå¤§ï¼Œåˆ™å°†è¾¹ç”»å¾—æ›´åšï¼Œåä¹‹äº¦ç„¶ï¼ˆè¿™ä¹Ÿæ˜¯æˆ‘æƒ³åˆ°çš„æœ€åä¸€ä¸ªæƒ³æ³•ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å¼€å§‹å§ï¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># è·å–åˆ›å»ºå¯è§†åŒ–æ‰€éœ€çš„æ•°æ®</span><br>all_nodes_unnormalized_scores, edge_index, node_labels, gat = gat_forward_pass(model_name, dataset_name)<br><br><span class="hljs-comment"># æˆ‘ä»¬è¦å¯è§†åŒ–å…¶é‚»è¿‘èŠ‚ç‚¹çš„å…³æ³¨åº¦çš„èŠ‚ç‚¹æ•°é‡</span><br>num_nodes_of_interest = <span class="hljs-number">4</span>  <span class="hljs-comment"># 4 æ˜¯ä¸€ä¸ªæ‚¨å¯ä»¥å°è¯•ä¸åŒå€¼çš„ä»»æ„æ•°å­—</span><br>head_to_visualize = <span class="hljs-number">0</span>  <span class="hljs-comment"># ç»˜åˆ¶æ¥è‡ªè¯¥å¤šå¤´æ³¨æ„åŠ›å¤´çš„æ³¨æ„åŠ›ï¼ˆä»…æœ€åä¸€å±‚æœ‰ä¸€ä¸ªå¤šå¤´ï¼‰</span><br>gat_layer_id = <span class="hljs-number">1</span>  <span class="hljs-comment"># ç»˜åˆ¶æ¥è‡ªè¯¥ GAT å±‚çš„æ³¨æ„åŠ›ï¼ˆç”±äºæˆ‘ä»¬çš„ GAT åªæœ‰ 2 å±‚ï¼Œè¿™æ˜¯æœ€åä¸€å±‚ï¼‰</span><br><br><span class="hljs-comment"># æ„å»ºå®Œæ•´å›¾</span><br><span class="hljs-comment"># node_features å½¢çŠ¶ =ï¼ˆNï¼ŒFINï¼‰ï¼Œå…¶ä¸­ N æ˜¯èŠ‚ç‚¹æ•°ï¼ŒFIN æ˜¯è¾“å…¥ç‰¹å¾æ•°</span><br>total_num_of_nodes = <span class="hljs-built_in">len</span>(node_features)<br>complete_graph = ig.Graph()<br>complete_graph.add_vertices(total_num_of_nodes)  <span class="hljs-comment"># igraph ä½¿ç”¨è¿™ç§æ ¼å¼åˆ›å»ºå¸¦æœ‰ [0ï¼Œtotal_num_of_nodes - 1] ID çš„èŠ‚ç‚¹</span><br>edge_index_tuples = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">zip</span>(edge_index[<span class="hljs-number">0</span>, :], edge_index[<span class="hljs-number">1</span>, :]))  <span class="hljs-comment"># igraph éœ€è¦è¿™ç§æ ¼å¼</span><br>complete_graph.add_edges(edge_index_tuples)<br><br><span class="hljs-comment"># é€‰æ‹©è¦ç»˜åˆ¶çš„ç›®æ ‡èŠ‚ç‚¹ï¼ˆå…·æœ‰æœ€é«˜åº¦æ•°çš„èŠ‚ç‚¹ + éšæœºèŠ‚ç‚¹ï¼‰</span><br><span class="hljs-comment"># æ³¨æ„ï¼šéšæœºèŠ‚ç‚¹å’Œå…·æœ‰æœ€é«˜åº¦æ•°çš„èŠ‚ç‚¹ä¹‹é—´å¯èƒ½å­˜åœ¨é‡å  - ä½†è¿™æ˜¯éå¸¸ä¸å¯èƒ½çš„</span><br>highest_degree_node_ids = np.argpartition(complete_graph.degree(), -num_nodes_of_interest)[-num_nodes_of_interest:]<br>random_node_ids = np.random.randint(low=<span class="hljs-number">0</span>, high=total_num_of_nodes, size=num_nodes_of_interest)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Highest degree nodes = <span class="hljs-subst">&#123;highest_degree_node_ids&#125;</span>&#x27;</span>)<br><br>target_node_ids = edge_index[<span class="hljs-number">1</span>]<br>source_nodes = edge_index[<span class="hljs-number">0</span>]<br><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># é€‰æ‹©è¦ä¸ºå…¶å¯è§†åŒ–å…³æ³¨åº¦çš„èŠ‚ç‚¹ IDï¼</span><br><span class="hljs-comment">#</span><br><br><span class="hljs-comment"># ç”±äºåœ¨ Jupyter ä¸­æ— æ³•ä½¿ç”¨ for å¾ªç¯ï¼Œåªéœ€è®¾ç½®ä¸€äº›æ•°å­—</span><br>target_node_id = <span class="hljs-number">306</span>  <span class="hljs-comment"># 306 æ˜¯ç¬¬äºŒåº¦æ•°æœ€é«˜çš„èŠ‚ç‚¹</span><br><br><span class="hljs-comment"># æ­¥éª¤ 1ï¼šæŸ¥æ‰¾ç›®æ ‡èŠ‚ç‚¹çš„é‚»è¿‘èŠ‚ç‚¹</span><br><span class="hljs-comment"># æ³¨æ„ï¼šå¯¹äº CORAï¼ŒåŒ…æ‹¬è‡ªç¯ï¼Œå› æ­¤ç›®æ ‡èŠ‚ç‚¹æ˜¯å…¶è‡ªèº«çš„é‚»å±…ï¼ˆAlexandroï¼Œyo soy tu madreï¼‰</span><br>src_nodes_indices = torch.eq(target_node_ids, target_node_id)<br>source_node_ids = source_nodes[src_nodes_indices].cpu().numpy()<br>size_of_neighborhood = <span class="hljs-built_in">len</span>(source_node_ids)<br><br><span class="hljs-comment"># æ­¥éª¤ 2ï¼šè·å–å®ƒä»¬çš„æ ‡ç­¾</span><br>labels = node_labels[source_node_ids].cpu().numpy()<br><br><span class="hljs-comment"># æ­¥éª¤ 3ï¼šè·å–è¾¹ç¼˜çš„æ³¨æ„åŠ›æƒé‡ï¼ˆåœ¨ä¸Šé¢çš„ GAT æ­£å‘ä¼ é€’æœŸé—´è®°å½•äº†æ³¨æ„åŠ›ï¼‰</span><br><span class="hljs-comment"># attention å½¢çŠ¶ =ï¼ˆNï¼ŒNHï¼Œ1ï¼‰-&gt;ï¼ˆNï¼ŒNHï¼‰ - æˆ‘ä»¬åªæŒ¤å‹äº†æœ€åä¸€ä¸ªç»´åº¦ï¼Œå®ƒæ˜¯å¤šä½™çš„</span><br>all_attention_weights = gat.gat_net[gat_layer_id].attention_weights.squeeze(dim=-<span class="hljs-number">1</span>)<br>attention_weights = all_attention_weights[src_nodes_indices, head_to_visualize].cpu().numpy()<br><span class="hljs-comment"># æ­¤éƒ¨åˆ†æ˜¾ç¤ºäº†å¯¹äº CORAï¼ŒGAT å­¦åˆ°çš„æ³¨æ„åŠ›æƒé‡å‡ ä¹æ˜¯å¸¸é‡ï¼ å°±åƒåœ¨ GCN ä¸­ä¸€æ ·ï¼</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Max attention weight = <span class="hljs-subst">&#123;np.<span class="hljs-built_in">max</span>(attention_weights)&#125;</span> and min = <span class="hljs-subst">&#123;np.<span class="hljs-built_in">min</span>(attention_weights)&#125;</span>&#x27;</span>)<br>attention_weights /= np.<span class="hljs-built_in">max</span>(attention_weights)  <span class="hljs-comment"># é‡æ–°ç¼©æ”¾æœ€å¤§æƒé‡ä¸º 1ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç»˜åˆ¶</span><br><br><span class="hljs-comment"># æ„å»ºæˆ‘ä»¬æƒ³è¦å¯è§†åŒ–æ³¨æ„åŠ›çš„é‚»å±…å›¾</span><br><span class="hljs-comment"># igraph çº¦æŸ - å®ƒä¸è¿ç»­èŒƒå›´çš„ ID ä¸€èµ·ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬å°†ä¾‹å¦‚èŠ‚ç‚¹ 497 æ˜ å°„åˆ° 0ï¼Œ12 åˆ° 1ï¼Œç­‰ç­‰ã€‚</span><br>id_to_igraph_id = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(source_node_ids, <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(source_node_ids))))<br>ig_graph = ig.Graph()<br>ig_graph.add_vertices(size_of_neighborhood)<br>ig_graph.add_edges([(id_to_igraph_id[neighbor], id_to_igraph_id[target_node_id]) <span class="hljs-keyword">for</span> neighbor <span class="hljs-keyword">in</span> source_node_ids])<br><br><span class="hljs-comment"># å‡†å¤‡å¯è§†åŒ–è®¾ç½®å­—å…¸å¹¶ç»˜å›¾</span><br>visual_style = &#123;<br>    <span class="hljs-string">&quot;edge_width&quot;</span>: attention_weights,  <span class="hljs-comment"># ä½¿è¾¹ç¼˜å°½å¯èƒ½ç²—</span><br>    <span class="hljs-string">&quot;layout&quot;</span>: ig_graph.layout_reingold_tilford_circular()  <span class="hljs-comment"># æ ‘çŠ¶å›¾çš„å¸ƒå±€</span><br>&#125;<br><span class="hljs-comment"># è¿™æ˜¯å”¯ä¸€é’ˆå¯¹ Cora çš„éƒ¨åˆ†ï¼Œå› ä¸º Cora æœ‰ 7 ä¸ªæ ‡ç­¾</span><br><span class="hljs-keyword">if</span> dataset_name.lower() == DatasetType.CORA.name.lower():<br>    visual_style[<span class="hljs-string">&quot;vertex_color&quot;</span>] = [cora_label_to_color_map[label] <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> labels]<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;ä¸ºæ‚¨ç‰¹å®šçš„æ•°æ®é›†æ·»åŠ è‡ªå®šä¹‰é¢œè‰²æ–¹æ¡ˆã€‚ ä½¿ç”¨ igraph é»˜è®¤ç€è‰²ã€‚&#x27;</span>)<br><br>ig.plot(ig_graph, **visual_style)<br><br></code></pre></td></tr></table></figure>

<pre><code class="hljs">***** æ¨¡å‹è®­ç»ƒå…ƒæ•°æ®: *****
commit_hash: 91fb864b8f9ddefd401bf5399cea779bd3c0a63b
dataset_name: CORA
num_of_epochs: 10000
test_acc: 0.822
num_of_layers: 2
num_heads_per_layer: [8, 1]
num_features_per_layer: [1433, 8, 7]
add_skip_connection: False
bias: True
dropout: 0.6
layer_type: IMP3
*********************

Highest degree nodes = [1986 1701  306 1358]
Max attention weight = 0.012915871106088161 and min = 0.012394174002110958


/var/folders/f0/812mfv7x63vbytjs3yf4gxtc0000gn/T/ipykernel_16269/2448994618.py:6: DeprecationWarning: Please use `csr_matrix` from the `scipy.sparse` namespace, the `scipy.sparse.csr` namespace is deprecated.
  data = pickle.load(file)
</code></pre>
<p><img src="https://ptpimg.me/mv5zat.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br><img src="https://ptpimg.me/855sl2.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br><img src="https://ptpimg.me/kk5k1q.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br><img src="https://ptpimg.me/02bw9r.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br><img src="https://ptpimg.me/8c77s3.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br><img src="https://ptpimg.me/6pt7d4.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br><img src="https://ptpimg.me/6q14cf.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br><img src="https://ptpimg.me/vdku0v.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"></p>
<p>ç§ï¼Œæµ…è“è‰²ç›´æ–¹å›¾ï¼ˆç»è¿‡è®­ç»ƒçš„ GATï¼‰ä¸æ©™è‰²ç›´æ–¹å›¾ï¼ˆç»Ÿä¸€æ³¨æ„åŠ› GATï¼‰å®Œå…¨åŒ¹é…ã€‚</p>
<p>å¦‚æœä¹‹å‰ç»˜åˆ¶çš„è¾¹çš„åšåº¦å¯è§†åŒ–ä¸èƒ½è®©æ‚¨ä¿¡æœï¼Œæˆ‘ç›¸ä¿¡ç†µå¯ä»¥ï¼</p>
<p>è¿™ç§å¯è§†åŒ–çš„æƒ³æ³•æ¥è‡ªPetar VeliÄkoviÄ‡ å‘æˆ‘æ¨èçš„<a target="_blank" rel="noopener" href="https://www.dgl.ai/blog/2019/02/17/gat.html">è¿™ç¯‡åšå®¢æ–‡ç« </a>ã€‚</p>
<hr>
<p>å”·ï¼ï¼ï¼å®Œæˆäº†ï¼å¦‚æœä½ ä¸€ç›´é™ªæˆ‘åˆ°è¿™é‡Œï¼Œæ­å–œä½ ï¼ï¼ˆæˆå°±å·²è§£é” - GATå¤§å¸ˆğŸ˜ï¼‰</p>
<p>å»ºè®®èŠ±ç‚¹æ—¶é—´åˆ†æä¸€ä¸‹è¿™ç¯‡åšå®¢ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªç©å…·é¡¹ç›®ï¼Œä½œè€…èŠ±äº†å¤§çº¦ 3 å‘¨çš„æ—¶é—´æ‰å®Œæˆï¼Œæ‰€ä»¥ä¸è¦æŒ‡æœ›åœ¨ 30 åˆ†é’Ÿå†…ç†è§£æ‰€æœ‰å†…å®¹ï¼Œé™¤éæ‚¨çœŸçš„ç†Ÿæ‚‰è¿™é‡Œæåˆ°çš„å¤§å¤šæ•°æ¦‚å¿µã€‚</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>GATæ•™ç¨‹</div>
      <div>https://gawain12.github.io/2023/11/01/GAT&#39;s Toturial/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Gawain</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2023å¹´11æœˆ1æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/09/11/Rag/" title="RAG æŠ€æœ¯æ¦‚è¦">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">RAG æŠ€æœ¯æ¦‚è¦</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/07/StanfordCars/" title="æ–¯å¦ç¦æ±½è½¦è¯†åˆ«">
                        <span class="hidden-mobile">æ–¯å¦ç¦æ±½è½¦è¯†åˆ«</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'Gawain12/comment-utterances');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
